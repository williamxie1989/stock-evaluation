<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>组合管理 - 智能股票分析系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com/?plugins=typography"></script>
    <script>
        const API_BASE = window.API_BASE || window.location.origin;
        function api(path) {
            return `${API_BASE}${path.startsWith('/') ? path : '/' + path}`;
        }
    </script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- 头部 -->
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">投资组合</h1>
            <a href="/" class="text-blue-600 hover:underline">返回首页</a>
        </div>

        <!-- 操作按钮 -->
        <div class="mb-4 flex justify-end">
            <button id="btnCreate" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">新建组合</button>
        </div>

        <!-- 概览统计 -->
        <div id="summaryPanel" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div class="bg-white rounded-lg shadow p-4">
                <p class="text-sm text-gray-500 mb-1">组合数量</p>
                <p class="text-2xl font-semibold text-gray-800" id="summaryCount">0</p>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <p class="text-sm text-gray-500 mb-1">平均组合净值</p>
                <p class="text-2xl font-semibold text-gray-800" id="summaryAvgNav">-</p>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <p class="text-sm text-gray-500 mb-1">平均日收益</p>
                <p class="text-2xl font-semibold text-gray-800" id="summaryAvgDaily">-</p>
            </div>
        </div>

        <!-- 列表表格 -->
        <div class="bg-white rounded-lg shadow overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 text-sm">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left font-medium text-gray-700">名称 / 策略</th>
                        <th class="px-4 py-2 text-left font-medium text-gray-700">持股数量</th>
                        <th class="px-4 py-2 text-left font-medium text-gray-700">组合净值</th>
                        <th class="px-4 py-2 text-left font-medium text-gray-700">当日收益</th>
                        <th class="px-4 py-2 text-left font-medium text-gray-700">累计收益</th>
                        <th class="px-4 py-2 text-left font-medium text-gray-700">风险等级</th>
                        <th class="px-4 py-2 text-left font-medium text-gray-700">创建时间</th>
                        <th class="px-4 py-2 text-left font-medium text-gray-700">操作</th>
                    </tr>
                </thead>
                <tbody id="portfolioTable" class="divide-y divide-gray-200"></tbody>
            </table>
            <div id="emptyHint" class="text-center text-gray-500 py-6 hidden">暂无组合，点击“新建组合”按钮创建吧！</div>
        </div>
    </div>

    <!-- 创建组合 Modal -->
    <div id="modalMask" class="fixed inset-0 bg-black bg-opacity-40 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg w-full max-w-md p-6">
            <h2 class="text-xl font-semibold mb-4">新建组合</h2>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">组合名称</label>
                <input id="inputName" type="text" placeholder="可留空自动生成" class="w-full px-3 py-2 border rounded">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">建仓方式</label>
                <select id="selectMode" class="w-full px-3 py-2 border rounded">
                    <option value="auto">智能推荐</option>
                    <option value="manual" disabled>手动创建（敬请期待）</option>
                </select>
            </div>
            <div class="mb-4" id="autoOptions">
                <label class="block text-sm font-medium text-gray-700 mb-1">股票数量 (Top N)</label>
                <input id="inputTopN" type="number" min="1" max="100" value="20" class="w-full px-3 py-2 border rounded">
                <label class="block text-sm font-medium text-gray-700 mt-4 mb-1">初始资金（元）</label>
                <input id="inputCapital" type="number" min="10000" step="10000" value="1000000" class="w-full px-3 py-2 border rounded" />
                <p class="text-xs text-gray-500 mt-1">资金越高，生成的持仓市值越大，净值计算会同步反映。</p>
            </div>
            <div class="flex justify-end gap-2">
                <button id="btnCancel" class="px-4 py-2 border rounded">取消</button>
                <button id="btnSubmit" class="px-4 py-2 bg-blue-600 text-white rounded">创建</button>
            </div>
        </div>
    </div>

<script>
// Modal 控制
const modalMask = document.getElementById('modalMask');
const btnCreate = document.getElementById('btnCreate');
const btnCancel = document.getElementById('btnCancel');
const btnSubmit = document.getElementById('btnSubmit');
const inputName = document.getElementById('inputName');
const inputTopN = document.getElementById('inputTopN');
const inputCapital = document.getElementById('inputCapital');
const selectMode = document.getElementById('selectMode');

function toggleModal(show) {
    if (show) {
        modalMask.classList.remove('hidden');
        setTimeout(() => inputName.focus(), 50);
    } else {
        modalMask.classList.add('hidden');
        inputName.value = '';
        inputTopN.value = 20;
        inputCapital.value = 1000000;
    }
}

btnCreate.onclick = () => toggleModal(true);
btnCancel.onclick = () => toggleModal(false);
modalMask.addEventListener('click', (evt) => {
    if (evt.target === modalMask) {
        toggleModal(false);
    }
});
document.addEventListener('keydown', (evt) => {
    if (evt.key === 'Escape' && !modalMask.classList.contains('hidden')) {
        toggleModal(false);
    }
});

// 表格与统计
const portfolioTable = document.getElementById('portfolioTable');
const emptyHint = document.getElementById('emptyHint');
const summaryCount = document.getElementById('summaryCount');
const summaryAvgNav = document.getElementById('summaryAvgNav');
const summaryAvgDaily = document.getElementById('summaryAvgDaily');
let loadRequestId = 0;

function formatNumber(value, digits = 2) {
    if (value === null || value === undefined || Number.isNaN(Number(value))) {
        return '-';
    }
    return Number(value).toFixed(digits);
}

function formatCurrency(value) {
    if (value === null || value === undefined || Number.isNaN(Number(value))) {
        return '-';
    }
    return Number(value).toLocaleString('zh-CN', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
}

function formatPercent(value) {
    if (value === null || value === undefined || Number.isNaN(Number(value))) {
        return '-';
    }
    const percent = Number(value) * 100;
    const fixed = percent.toFixed(2);
    const sign = percent > 0 ? '+' : '';
    return `${sign}${fixed}%`;
}

function percentClass(value) {
    if (value === null || value === undefined || Number.isNaN(Number(value)) || Number(value) === 0) {
        return 'text-gray-600';
    }
    return Number(value) > 0 ? 'text-red-600' : 'text-green-600';
}

function applyPercentClass(el, value) {
    el.classList.remove('text-red-600', 'text-green-600', 'text-gray-600');
    el.classList.add(percentClass(value));
}

function formatDateTime(value) {
    if (!value) return '-';
    const dt = new Date(value);
    if (Number.isNaN(dt.getTime())) return '-';
    return dt.toLocaleString();
}

function renderStrategyTags(tags = [], benchmark) {
    const tagHtml = (tags || []).map(tag => `<span class="inline-flex items-center px-2 py-0.5 rounded bg-blue-50 text-blue-700 text-xs">${tag}</span>`).join('');
    const benchmarkHtml = benchmark ? `<span class="inline-flex items-center px-2 py-0.5 rounded bg-gray-100 text-gray-600 text-xs">基准 ${benchmark}</span>` : '';
    if (!tagHtml && !benchmarkHtml) return '';
    return `<div class="mt-1 flex flex-wrap gap-1">${tagHtml}${benchmarkHtml}</div>`;
}

function riskBadge(level, benchmark) {
    if (!level && !benchmark) return '-';
    const clsMap = {
        '高': 'bg-red-100 text-red-700',
        '中': 'bg-yellow-100 text-yellow-700',
        '低': 'bg-green-100 text-green-700'
    };
    const badge = level
        ? `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${clsMap[level] || 'bg-gray-100 text-gray-600'}">${level}</span>`
        : '';
    const benchmarkInfo = benchmark
        ? `<span class="text-xs text-gray-500">${benchmark}</span>`
        : '';
    return `<div class="flex flex-col gap-1">${badge}${benchmarkInfo ? `<div>${benchmarkInfo}</div>` : ''}</div>`;
}

function buildRow(portfolio) {
    const tr = document.createElement('tr');
    const navValue = formatNumber(portfolio.nav_value, 4);
    const totalValue = formatCurrency(portfolio.total_value);
    const dailyReturn = formatPercent(portfolio.daily_return_pct);
    const totalReturn = formatPercent(portfolio.total_return_pct);
    tr.innerHTML = `
        <td class="px-4 py-3 align-top">
            <div class="font-semibold text-gray-800">${portfolio.name}</div>
            ${renderStrategyTags(portfolio.strategy_tags, portfolio.benchmark)}
        </td>
        <td class="px-4 py-3 align-top text-gray-700">${portfolio.holdings_count}</td>
        <td class="px-4 py-3 align-top">
            <div class="font-medium text-gray-800">${navValue}</div>
            <div class="text-xs text-gray-500 mt-1">总资产 ¥${totalValue}</div>
        </td>
        <td class="px-4 py-3 align-top ${percentClass(portfolio.daily_return_pct)} font-medium">${dailyReturn}</td>
        <td class="px-4 py-3 align-top ${percentClass(portfolio.total_return_pct)} font-medium">${totalReturn}</td>
        <td class="px-4 py-3 align-top">${riskBadge(portfolio.risk_level, portfolio.benchmark)}</td>
        <td class="px-4 py-3 align-top text-gray-600">${formatDateTime(portfolio.created_at)}</td>
        <td class="px-4 py-3 align-top">
            <div class="flex items-center gap-3">
                <a href="./portfolio_detail.html?id=${portfolio.id}" class="text-blue-600 hover:underline">查看</a>
                <button type="button" class="text-red-600 hover:underline btn-delete">删除</button>
            </div>
        </td>
    `;
    const deleteBtn = tr.querySelector('.btn-delete');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', () => handleDeletePortfolio(portfolio, deleteBtn));
    }
    return tr;
}

async function loadPortfolios(options = {}) {
    const { forceRefresh = true, showSpinner = true } = options;
    const requestId = ++loadRequestId;
    if (showSpinner) {
        portfolioTable.innerHTML = `
            <tr>
                <td colspan="8" class="px-4 py-6 text-center text-gray-500">加载中...</td>
            </tr>
        `;
        emptyHint.classList.add('hidden');
    }
    try {
        const basePath = forceRefresh ? '/api/portfolios?refresh=1' : '/api/portfolios';
        const separator = basePath.includes('?') ? '&' : '?';
        const res = await fetch(api(`${basePath}${separator}ts=${Date.now()}`), { cache: 'no-store' });
        const json = await res.json();
        if (!json.success) {
            throw new Error(json.error || '未知错误');
        }
        if (requestId !== loadRequestId) {
            return;
        }
        const list = json.portfolios || [];
        summaryCount.textContent = list.length;
        if (list.length === 0) {
            summaryAvgNav.textContent = '-';
            summaryAvgDaily.textContent = '-';
            summaryAvgDaily.classList.remove('text-red-600', 'text-green-600', 'text-gray-600');
            summaryAvgDaily.classList.add('text-gray-600');
            emptyHint.classList.remove('hidden');
            return;
        }
        portfolioTable.innerHTML = '';
        const navAvg = list.reduce((sum, item) => sum + (Number(item.nav_value) || 0), 0) / list.length;
        const dailyAvg = list.reduce((sum, item) => sum + (Number(item.daily_return_pct) || 0), 0) / list.length;
        summaryAvgNav.textContent = formatNumber(navAvg, 4);
        summaryAvgDaily.textContent = formatPercent(dailyAvg);
        applyPercentClass(summaryAvgDaily, dailyAvg);

        list.forEach(portfolio => {
            portfolioTable.appendChild(buildRow(portfolio));
        });
    } catch (error) {
        console.error(error);
        if (requestId !== loadRequestId) {
            return;
        }
        if (showSpinner) {
            alert(`获取组合列表失败：${error.message}`);
        }
        summaryCount.textContent = '0';
        summaryAvgNav.textContent = '-';
        summaryAvgDaily.textContent = '-';
        summaryAvgDaily.classList.remove('text-red-600', 'text-green-600');
        summaryAvgDaily.classList.add('text-gray-600');
        portfolioTable.innerHTML = '';
        emptyHint.classList.remove('hidden');
    }
}

async function handleDeletePortfolio(portfolio, button) {
    const name = portfolio.name || `组合${portfolio.id}`;
    if (!window.confirm(`确定要删除组合「${name}」吗？此操作不可恢复。`)) {
        return;
    }
    const originalText = button.textContent;
    button.disabled = true;
    button.textContent = '删除中...';
    try {
        const res = await fetch(api(`/api/portfolios/${portfolio.id}`), {
            method: 'DELETE'
        });
        const json = await res.json().catch(() => ({}));
        if (!res.ok || !json.success) {
            throw new Error(json.error || `服务返回状态码 ${res.status}`);
        }
        await loadPortfolios({ forceRefresh: false });
        loadPortfolios({ forceRefresh: true, showSpinner: false });
    } catch (error) {
        console.error(error);
        alert(`删除组合失败：${error.message}`);
    } finally {
        if (button && button.isConnected) {
            button.disabled = false;
            button.textContent = originalText;
        }
    }
}

async function createPortfolio() {
    if (selectMode.value !== 'auto') {
        alert('当前仅支持智能推荐建仓。');
        return;
    }
    const payload = {
        name: inputName.value.trim(),
        mode: 'auto',
        top_n: Number(inputTopN.value),
        initial_capital: Number(inputCapital.value)
    };
    if (!Number.isFinite(payload.top_n) || payload.top_n < 1) {
        alert('Top N 必须大于等于 1');
        return;
    }
    if (!Number.isFinite(payload.initial_capital) || payload.initial_capital <= 0) {
        alert('初始资金必须大于 0');
        return;
    }
    btnSubmit.disabled = true;
    const originalText = btnSubmit.textContent;
    btnSubmit.textContent = '创建中...';
    try {
        const res = await fetch(api('/api/portfolios'), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const json = await res.json();
        if (!json.success) {
            throw new Error(json.error || '创建组合失败');
        }
        toggleModal(false);
        await loadPortfolios({ forceRefresh: false });
        loadPortfolios({ forceRefresh: true, showSpinner: false });
    } catch (error) {
        console.error(error);
        alert(`创建失败：${error.message}`);
    } finally {
        btnSubmit.disabled = false;
        btnSubmit.textContent = originalText;
    }
}

btnSubmit.onclick = createPortfolio;

// 初次加载：先展示已有数据，再触发刷新
(async () => {
    await loadPortfolios({ forceRefresh: false });
    loadPortfolios({ forceRefresh: true, showSpinner: false });
})();
</script>
</body>
</html>
