<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个股分析 - 股票分析系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap">
<link rel="stylesheet" href="/static/css/ai-analysis.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 导航栏 -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-semibold text-gray-900">个股分析</h1>
                  </div>
</section>
                <div class="flex items-center space-x-4">
                    <button onclick="window.close()" class="px-4 py-2 text-gray-600 hover:text-gray-900 transition-colors duration-200">
                        关闭
                    </button>
                    <a href="/" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">
                        返回首页
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要内容 -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- 股票信息卡片 -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 id="stockSymbol" class="text-2xl font-bold text-gray-900">-</h2>
                    <p id="stockName" class="text-gray-600">加载中...</p>
                </div>
                <div class="text-right">
                    <p id="currentPrice" class="text-3xl font-bold text-gray-900">-</p>
                    <p id="priceChange" class="text-lg">-</p>
                </div>
            </div>
            
            <!-- 基本信息 - 参考雪球页面布局 -->
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-3 mt-4 text-sm">
                <div class="text-center p-2 bg-gray-50 rounded-lg">
                    <p class="text-gray-500">今开</p>
                    <p id="openPrice" class="font-semibold text-gray-900">-</p>
                </div>
                <div class="text-center p-2 bg-gray-50 rounded-lg">
                    <p class="text-gray-500">最高</p>
                    <p id="highPrice" class="font-semibold text-red-600">-</p>
                </div>
                <div class="text-center p-2 bg-gray-50 rounded-lg">
                    <p class="text-gray-500">最低</p>
                    <p id="lowPrice" class="font-semibold text-green-600">-</p>
                </div>
                <div class="text-center p-2 bg-gray-50 rounded-lg">
                    <p class="text-gray-500">成交量</p>
                    <p id="volume" class="font-semibold text-gray-900">-</p>
                </div>
                <div class="text-center p-2 bg-gray-50 rounded-lg">
                    <p class="text-gray-500">成交额</p>
                    <p id="turnover" class="font-semibold text-gray-900">-</p>
                </div>
                <div class="text-center p-2 bg-gray-50 rounded-lg">
                    <p class="text-gray-500">振幅</p>
                    <p id="amplitude" class="font-semibold text-gray-900">-</p>
                </div>
                <div class="text-center p-2 bg-gray-50 rounded-lg">
                    <p class="text-gray-500">换手率</p>
                    <p id="turnoverRate" class="font-semibold text-gray-900">-</p>
                </div>
                <div class="text-center p-2 bg-gray-50 rounded-lg">
                    <p class="text-gray-500">昨收</p>
                    <p id="previousClose" class="font-semibold text-gray-900">-</p>
                </div>
            </div>
            
            <!-- 更多股票信息 -->
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 mt-3 text-sm">
                <div class="text-center p-2 bg-blue-50 rounded-lg">
                    <p class="text-gray-500">总市值</p>
                    <p id="marketCap" class="font-semibold text-gray-900">-</p>
                </div>
                <div class="text-center p-2 bg-blue-50 rounded-lg">
                    <p class="text-gray-500">流通值</p>
                    <p id="floatCap" class="font-semibold text-gray-900">-</p>
                </div>
                <div class="text-center p-2 bg-blue-50 rounded-lg">
                    <p class="text-gray-500">市盈率(TTM)</p>
                    <p id="peRatio" class="font-semibold text-gray-900">-</p>
                </div>
                <div class="text-center p-2 bg-blue-50 rounded-lg">
                    <p class="text-gray-500">市净率</p>
                    <p id="pbRatio" class="font-semibold text-gray-900">-</p>
                </div>
                <div class="text-center p-2 bg-blue-50 rounded-lg">
                    <p class="text-gray-500">每股收益</p>
                    <p id="eps" class="font-semibold text-gray-900">-</p>
                </div>
                <div class="text-center p-2 bg-blue-50 rounded-lg">
                    <p class="text-gray-500">股息率</p>
                    <p id="dividendYield" class="font-semibold text-gray-900">-</p>
                </div>
            </div>
        </div>

        <!-- AI智能分析 - 全宽显示 -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h3 class="text-lg font-semibold mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                </svg>
                AI智能分析
            </h3>
            <section id="aiAnalysis" class="markdown-body-ai px-6 py-8 bg-white rounded-xl shadow-xl">
  <article class="max-w-4xl mx-auto space-y-10">
  <div class="analysis-container space-y-8">
                <div class="flex items-center justify-center py-8">
                    <div class="loading w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full"></div>
                    <span class="ml-2">分析中...</span>
                </div>
            </div>
        </div>

        <!-- 分析结果 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- 交易信号 -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    交易信号
                </h3>
                <div id="tradingSignals" class="space-y-3">
                    <div class="flex items-center justify-center py-8">
                        <div class="loading w-6 h-6 border-2 border-yellow-600 border-t-transparent rounded-full"></div>
                        <span class="ml-2">计算中...</span>
                    </div>
                </div>
            </div>

            <!-- 技术指标 -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    技术指标
                </h3>
                <div id="technicalIndicators" class="space-y-3">
                    <div class="flex items-center justify-center py-8">
                        <div class="loading w-6 h-6 border-2 border-green-600 border-t-transparent rounded-full"></div>
                        <span class="ml-2">计算中...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- K线图 -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h3 class="text-lg font-semibold mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                </svg>
                K线图表
            </h3>
            <div id="stockChart" style="height: 400px;"></div>
        </div>

        <!-- 回测结果 -->
        <div id="backtestResults" class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex items-center justify-center py-8">
                <div class="loading w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full"></div>
                <span class="ml-2">计算中...</span>
            </div>
        </div>

        <!-- 风险报告 -->
        <div id="riskReport" class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex items-center justify-center py-8">
                <div class="loading w-6 h-6 border-2 border-red-600 border-t-transparent rounded-full"></div>
                <span class="ml-2">计算中...</span>
            </div>
        </div>
    </div>

    <script>
        // 获取URL参数
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // 格式化数字
        function formatNumber(num) {
            if (num === null || num === undefined) return '-';
            if (num >= 100000000) {
                return (num / 100000000).toFixed(2) + '亿';
            } else if (num >= 10000) {
                return (num / 10000).toFixed(2) + '万';
            }
            return num.toLocaleString();
        }

        // 格式化价格变化
        function formatPriceChange(change, changePercent) {
            if (change === null || change === undefined) return '-';
            const changeStr = change >= 0 ? `+${change.toFixed(2)}` : change.toFixed(2);
            const percentStr = changePercent >= 0 ? `+${changePercent.toFixed(2)}%` : `${changePercent.toFixed(2)}%`;
            const colorClass = change >= 0 ? 'text-red-600' : 'text-green-600';
            return `<span class="${colorClass}">${changeStr} (${percentStr})</span>`;
        }

        // 加载股票分析
        async function loadStockAnalysis(symbol) {
            if (!symbol) {
                document.getElementById('aiAnalysis').innerHTML = '<p class="text-red-600">未指定股票代码</p>';
                return;
            }

            try {
                // 更新页面标题
                document.title = `${symbol} - 个股分析`;
                document.getElementById('stockSymbol').textContent = symbol;

                // 调用分析API
                const response = await fetch('http://localhost:8003/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ symbol: symbol })
                });

                const data = await response.json();

                if (data.success && data.data && data.data.success) {
                    const result = data.data;
                    
                    // 更新基本信息
                    if (result.stock_info) {
                        const info = result.stock_info;
                        document.getElementById('stockName').textContent = info.longName || symbol;
                        document.getElementById('currentPrice').textContent = result.latest_price ? `¥${result.latest_price.toFixed(2)}` : '-';
                        document.getElementById('priceChange').innerHTML = '-'; // 暂时显示为-
                        document.getElementById('openPrice').textContent = '-';
                        document.getElementById('highPrice').textContent = '-';
                        document.getElementById('lowPrice').textContent = '-';
                        document.getElementById('volume').textContent = '-';
                    }

                    // 更新AI分析 - 使用marked解析markdown，全宽显示
                    if (result.ai_analysis) {
                        const parsedMarkdown = marked.parse(result.ai_analysis);
                        document.getElementById('aiAnalysis').innerHTML = `
                            <div class="fade-in">
                                <div class="prose max-w-none">
                                    ${parsedMarkdown}
                                </div>
                            </div>
                        `;
                    } else {
                        document.getElementById('aiAnalysis').innerHTML = '<p class="text-gray-500">暂无分析数据</p>';
                    }

                    // 更新股票基本信息（顶部区域）
                    const stockInfo = result.stock_info;
                    if (stockInfo) {
                        // 基础价格信息
                        document.getElementById('openPrice').textContent = stockInfo.open_price ? formatPriceChange(stockInfo.open_price) : '-';
                        document.getElementById('highPrice').textContent = stockInfo.high_price ? formatPriceChange(stockInfo.high_price) : '-';
                        document.getElementById('lowPrice').textContent = stockInfo.low_price ? formatPriceChange(stockInfo.low_price) : '-';
                        document.getElementById('volume').textContent = stockInfo.volume ? formatNumber(stockInfo.volume) : '-';
                        document.getElementById('turnover').textContent = stockInfo.turnover ? formatNumber(stockInfo.turnover) : '-';
                        document.getElementById('amplitude').textContent = stockInfo.amplitude ? stockInfo.amplitude + '%' : '-';
                        document.getElementById('turnoverRate').textContent = stockInfo.turnover_rate ? stockInfo.turnover_rate + '%' : '-';
                        document.getElementById('previousClose').textContent = stockInfo.previous_close ? formatPriceChange(stockInfo.previous_close) : '-';
                        
                        // 更多股票信息
                        document.getElementById('marketCap').textContent = stockInfo.market_cap ? formatNumber(stockInfo.market_cap) : '-';
                        document.getElementById('floatCap').textContent = stockInfo.float_cap ? formatNumber(stockInfo.float_cap) : '-';
                        document.getElementById('peRatio').textContent = stockInfo.pe_ratio || '-';
                        document.getElementById('pbRatio').textContent = stockInfo.pb_ratio || '-';
                        document.getElementById('eps').textContent = stockInfo.eps || '-';
                        document.getElementById('dividendYield').textContent = stockInfo.dividend_yield ? stockInfo.dividend_yield + '%' : '-';
                    }

                    // 更新交易信号 - 处理不同的数据结构
                    if (result.signals && result.signals.length > 0) {
                        const signalsHtml = result.signals.map(signal => {
                            // 处理不同的字段名格式
                            const signalType = signal.signal_type || signal.type || 'hold';
                            const signalName = signal.signal_name || signal.name || '交易信号';
                            const confidence = signal.confidence || signal.score || 0;
                            const description = signal.description || signal.reason || '';
                            const price = signal.price || signal.signal_price || null;
                            const signalDate = signal.date || signal.signal_date || '';
                            
                            const signalClass = signalType.toLowerCase() === 'buy' ? 'bg-green-100 border-green-300' : 
                                              signalType.toLowerCase() === 'sell' ? 'bg-red-100 border-red-300' : 
                                              'bg-yellow-100 border-yellow-300';
                            const signalIcon = signalType.toLowerCase() === 'buy' ? '↑' : 
                                             signalType.toLowerCase() === 'sell' ? '↓' : '⚠';
                            const signalTextClass = signalType.toLowerCase() === 'buy' ? 'text-green-800' : 
                                                  signalType.toLowerCase() === 'sell' ? 'text-red-800' : 
                                                  'text-yellow-800';
                            
                            let priceInfo = '';
                            if (price !== null && price !== undefined) {
                                const priceColorClass = signalType.toLowerCase() === 'buy' ? 'text-green-600' : 
                                                       signalType.toLowerCase() === 'sell' ? 'text-red-600' : 
                                                       'text-yellow-600';
                                priceInfo = `<span class="${priceColorClass} font-semibold"> @ ¥${price.toFixed(2)}</span>`;
                            }
                            
                            let dateInfo = '';
                            if (signalDate) {
                                dateInfo = `<div class="text-xs text-gray-500 mt-1">${signalDate}</div>`;
                            }
                            
                            return `
                                <div class="p-3 rounded-lg border ${signalClass}">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <span class="text-lg font-bold mr-2">${signalIcon}</span>
                                            <span class="font-semibold ${signalTextClass}">${signalName}</span>
                                            ${priceInfo}
                                        </div>
                                        <span class="text-sm opacity-75">${confidence}%</span>
                                    </div>
                                    <p class="text-sm mt-1 opacity-90 ${signalTextClass}">${description}</p>
                                    ${dateInfo}
                                </div>
                            `;
                        }).join('');
                        document.getElementById('tradingSignals').innerHTML = signalsHtml;
                    } else {
                        document.getElementById('tradingSignals').innerHTML = '<p class="text-gray-500 text-center py-4">暂无交易信号</p>';
                    }

                    // 更新技术指标（只保留纯技术指标，取最新值并优化精度）
                    const technicalData = result.technical_data;
                    
                    // 定义允许的技术指标列表，只保留真正的技术指标
                    const allowedTechnicalIndicators = [
                        'MA5', 'MA10', 'MA20', 'MA30', 'MA60', 'MA120', 'MA240',
                        'RSI', 'RSI6', 'RSI12', 'RSI24',
                        'MACD', 'MACD_Signal', 'MACD_Hist', 'MACD_DIFF', 'MACD_DEA',
                        'KDJ_K', 'KDJ_D', 'KDJ_J',
                        'BB_Upper', 'BB_Lower', 'BB_Middle', 'BB_Bandwidth',
                        'BOLL_Upper', 'BOLL_Lower', 'BOLL_Middle', 'BOLL_Bandwidth',
                        'WILLR', 'CCI', 'SAR', 'DMA', 'EXPMA', 'TRIX', 'BIAS', 'ROC',
                        'MIKE_S', 'MIKE_R', 'MIKE_WS', 'MIKE_WR'
                    ];
                    
                    const indicatorsHtml = Object.entries(technicalData)
                        .filter(([key]) => {
                            // 只允许明确的技术指标，排除所有其他数据
                            return allowedTechnicalIndicators.includes(key);
                        })
                        .map(([key, value]) => {
                            const displayName = {
                                'ma5': 'MA5',
                                'ma10': 'MA10', 
                                'ma20': 'MA20',
                                'ma30': 'MA30',
                                'ma60': 'MA60',
                                'rsi': 'RSI',
                                'rsi6': 'RSI6',
                                'rsi12': 'RSI12',
                                'rsi24': 'RSI24',
                                'macd': 'MACD',
                                'macd_diff': 'MACD-DIFF',
                                'macd_dea': 'MACD-DEA',
                                'kdj_k': 'KDJ-K',
                                'kdj_d': 'KDJ-D',
                                'kdj_j': 'KDJ-J',
                                'boll_upper': 'BOLL上轨',
                                'boll_middle': 'BOLL中轨',
                                'boll_lower': 'BOLL下轨',
                                'boll_bandwidth': 'BOLL带宽',
                                'willr': 'WILLR',
                                'cci': 'CCI',
                                'sar': 'SAR',
                                'dma': 'DMA',
                                'expma': 'EXPMA',
                                'trix': 'TRIX',
                                'bias': 'BIAS',
                                'roc': 'ROC',
                                'mike_s': 'MIKE-S',
                                'mike_r': 'MIKE-R',
                                'mike_ws': 'MIKE-WS',
                                'mike_wr': 'MIKE-WR'
                            }[key.toLowerCase()] || key.toUpperCase();
                            
                            let displayValue = 'N/A';
                            // 取最新值（数组最后一个或单个数值）
                            const latestValue = Array.isArray(value) && value.length ? value[value.length - 1] : value;
                            if (typeof latestValue === 'number') {
                                const k = key.toLowerCase();
                                if (k.includes('rsi') || k.includes('willr') || k.includes('bias')) {
                                    displayValue = latestValue.toFixed(1) + '%';
                                } else if (k.includes('macd')) {
                                    displayValue = latestValue.toFixed(3);
                                } else if (k.includes('boll') || k.includes('ma') || k.includes('kdj')) {
                                    displayValue = latestValue.toFixed(2);
                                } else if (latestValue > 1000) {
                                    displayValue = latestValue.toFixed(0);
                                } else {
                                    displayValue = latestValue.toFixed(2);
                                }
                            } else if (typeof latestValue === 'string') {
                                displayValue = latestValue;
                            }
                            
                            return `
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <p class="text-sm text-gray-600">${displayName}</p>
                                    <p class="font-semibold">${displayValue}</p>
                                </div>
                            `;
                        }).join('');
                    
                    document.getElementById('technicalIndicators').innerHTML = indicatorsHtml || '<p class="text-gray-500 text-center py-4">暂无技术指标数据</p>';

                    // 渲染K线图
                    if (result.chart_data) {
                        renderStockChart(result.chart_data);
                    }
                    
                    // 显示回测结果
                    if (result.backtest) {
                        displayBacktestResults(result.backtest);
                    }
                    
                    // 显示风险报告
                    if (result.risk_report) {
                        displayRiskReport(result.risk_report);
                    }
                } else {
                    document.getElementById('aiAnalysis').innerHTML = `<p class="text-red-600">分析失败: ${data.error || '未知错误'}</p>`;
                }
            } catch (error) {
                console.error('加载分析失败:', error);
                document.getElementById('aiAnalysis').innerHTML = '<p class="text-red-600">网络错误，请稍后重试</p>';
            }
        }

        // 渲染K线图
        function renderStockChart(chartData) {
            console.log('=== 修复版renderStockChart函数 ===');
            const container = document.getElementById('stockChart');
            
            // 销毁现有图表实例避免冲突
            const existingChart = echarts.getInstanceByDom(container);
            if (existingChart) {
                existingChart.dispose();
            }
            
            const chart = echarts.init(container);

            // 准备数据
            const dates = (chartData.kline || []).map(item => item.date);
            const kValues = (chartData.kline || []).map(item => [item.open, item.close, item.low, item.high]);
            
            // 准备回测数据
            const portfolioData = chartData.portfolio || [];
            const tradeMarkers = (chartData.trade_markers || []).map(marker => ({
                date: marker.date,
                type: marker.type.toUpperCase(), // 确保类型为大写
                price: parseFloat(marker.price) // 确保价格为数字
            }));
            
            const portfolioValues = portfolioData.map(item => item.value);
            const buySignals = tradeMarkers.filter(s => s.type === 'BUY');
            const sellSignals = tradeMarkers.filter(s => s.type === 'SELL');
            
            console.log('交易信号统计:', {
                totalMarkers: tradeMarkers.length,
                buySignals: buySignals.length,
                sellSignals: sellSignals.length
            });

            // 创建买入信号数据点 - 确保映射正确
            const buySignalData = buySignals.map(signal => {
                console.log(`买入信号: 日期=${signal.date}, 价格=${signal.price}`);
                return [signal.date, signal.price];
            });
            
            // 创建卖出信号数据点 - 确保映射正确
            const sellSignalData = sellSignals.map(signal => {
                console.log(`卖出信号: 日期=${signal.date}, 价格=${signal.price}`);
                return [signal.date, signal.price];
            });

            const option = {
                backgroundColor: '#fff',
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' },
                    formatter: function(params) {
                        let result = `<strong>${params[0].name}</strong><br/>`;
                        params.forEach(param => {
                            if (param.seriesName === 'K线') {
                                result += `开盘: ${param.data[0]}<br/>收盘: ${param.data[1]}<br/>最低: ${param.data[2]}<br/>最高: ${param.data[3]}<br/>`;
                            } else if (param.seriesName === '买入信号') {
                                result += `<span style="color: #22c55e">🔺 买入信号: ${param.data[1]}元</span><br/>`;
                            } else if (param.seriesName === '卖出信号') {
                                result += `<span style="color: #ef4444">🔻 卖出信号: ${param.data[1]}元</span><br/>`;
                            } else if (param.seriesName === '组合净值') {
                                result += `组合净值: ${param.data}<br/>`;
                            }
                        });
                        return result;
                    }
                },
                legend: {
                    data: ['K线', '组合净值', '买入信号', '卖出信号']
                },
                grid: {
                    left: '10%',
                    right: '15%',
                    bottom: '15%'
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    scale: true,
                    boundaryGap: false,
                    axisLine: { onZero: false },
                    splitLine: { show: false },
                    min: 'dataMin',
                    max: 'dataMax'
                },
                yAxis: [
                    {
                        type: 'value',
                        name: '股价 (元)',
                        position: 'left',
                        scale: true,
                        splitArea: { show: true },
                        axisLabel: {
                            formatter: '{value}元'
                        }
                    },
                    {
                        type: 'value',
                        name: '组合净值',
                        position: 'right',
                        scale: true,
                        splitArea: { show: false },
                        axisLabel: {
                            formatter: function(value) {
                                if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
                                if (value >= 1000) return (value / 1000).toFixed(1) + 'K';
                                return value.toFixed(0);
                            }
                        }
                    }
                ],
                dataZoom: [
                    {
                        type: 'inside',
                        start: 50,
                        end: 100
                    },
                    {
                        show: true,
                        type: 'slider',
                        top: '90%',
                        start: 50,
                        end: 100
                    }
                ],
                series: [
                    {
                        name: 'K线',
                        type: 'candlestick',
                        data: kValues,
                        yAxisIndex: 0,
                        itemStyle: {
                            color: '#ef4444',
                            color0: '#22c55e',
                            borderColor: '#ef4444',
                            borderColor0: '#22c55e'
                        }
                    },
                    {
                        name: '组合净值',
                        type: 'line',
                        data: portfolioValues,
                        yAxisIndex: 1,
                        smooth: true,
                        lineStyle: {
                            color: '#3b82f6',
                            width: 2
                        },
                        symbol: 'none'
                    },
                    {
                        name: '买入信号',
                        type: 'scatter',
                        data: buySignalData,
                        yAxisIndex: 0,
                        symbol: 'triangle',
                        symbolSize: 25,
                        itemStyle: {
                            color: '#22c55e'
                        },
                        emphasis: {
                            itemStyle: {
                                color: '#16a34a',
                                borderColor: '#fff',
                                borderWidth: 2
                            }
                        }
                    },
                    {
                        name: '卖出信号',
                        type: 'scatter',
                        data: sellSignalData,
                        yAxisIndex: 0,
                        symbol: 'triangle-down',
                        symbolSize: 25,
                        itemStyle: {
                            color: '#ef4444'
                        },
                        emphasis: {
                            itemStyle: {
                                color: '#dc2626',
                                borderColor: '#fff',
                                borderWidth: 2
                            }
                        }
                    }
                ]
            };

            chart.setOption(option);
            
            // 强制显示所有系列
            chart.setOption({
                legend: {
                    selected: {
                        'K线': true,
                        '组合净值': true,
                        '买入信号': true,
                        '卖出信号': true
                    }
                }
            });

            // 响应式调整
            window.addEventListener('resize', () => {
                chart.resize();
            });
            
            console.log('修复版图表渲染完成');
            console.log('买入信号数据:', buySignalData);
            console.log('卖出信号数据:', sellSignalData);
        }

        // 页面加载时执行
        document.addEventListener('DOMContentLoaded', function() {
            const symbol = getUrlParameter('symbol');
            loadStockAnalysis(symbol);
        });

        // 显示回测结果
        function displayBacktestResults(results) {
            const container = document.getElementById('backtestResults');
            if (!container) return;
            
            // 获取性能指标数据
            const metrics = results.performance_metrics || results;
            
            let html = `
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-4">回测结果</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center">
                            <p class="text-sm text-gray-600">总收益率</p>
                            <p class="text-xl font-bold ${metrics.total_return >= 0 ? 'text-green-600' : 'text-red-600'}">
                                ${metrics.total_return ? metrics.total_return.toFixed(2) : '0.00'}%
                            </p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-600">年化收益率</p>
                            <p class="text-xl font-bold ${metrics.annualized_return >= 0 ? 'text-green-600' : 'text-red-600'}">
                                ${metrics.annualized_return ? metrics.annualized_return.toFixed(2) : '0.00'}%
                            </p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-600">最大回撤</p>
                            <p class="text-xl font-bold text-red-600">
                                ${metrics.max_drawdown ? metrics.max_drawdown.toFixed(2) : '0.00'}%
                            </p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-600">夏普比率</p>
                            <p class="text-xl font-bold">
                                ${metrics.sharpe_ratio ? metrics.sharpe_ratio.toFixed(2) : '0.00'}
                            </p>
                        </div>
                    </div>
                    
                    ${metrics.win_rate !== undefined ? `
                    <div class="mt-4 pt-4 border-t">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">胜率</p>
                                <p class="font-semibold">${metrics.win_rate.toFixed(2)}%</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">交易次数</p>
                                <p class="font-semibold">${metrics.total_trades || 0}</p>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
            
            container.innerHTML = html;
        }

        // 显示风险报告
        function displayRiskReport(riskReport) {
            const container = document.getElementById('riskReport');
            if (!container) return;
            
            const riskColor = getRiskColor(riskReport.risk_level);
            
            let html = `
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-4">风险报告</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">风险等级</span>
                            <span class="px-3 py-1 rounded-full text-sm font-medium ${riskColor}">
                                ${riskReport.risk_level}
                            </span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">风险评分</span>
                            <span class="font-semibold">${riskReport.risk_score}/100</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">建议仓位</span>
                            <span class="font-semibold">${riskReport.suggested_position || '中等'}</span>
                        </div>
                        ${riskReport.risk_factors ? `
                        <div class="pt-4 border-t">
                            <p class="text-sm text-gray-600 mb-2">主要风险因素</p>
                            <ul class="text-sm space-y-1">
                                ${riskReport.risk_factors.map(factor => `<li>• ${factor}</li>`).join('')}
                            </ul>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // 获取风险颜色
        function getRiskColor(riskLevel) {
            switch (riskLevel) {
                case '低风险':
                    return 'bg-green-100 text-green-800';
                case '中等风险':
                    return 'bg-yellow-100 text-yellow-800';
                case '高风险':
                    return 'bg-red-100 text-red-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }
    </script>
</body>
</html>