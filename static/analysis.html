<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªè‚¡åˆ†æ - è‚¡ç¥¨åˆ†æç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap">
<link rel="stylesheet" href="/static/css/ai-analysis.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- å¯¼èˆªæ  -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-semibold text-gray-900">ä¸ªè‚¡åˆ†æ</h1>
                  </div>
</section>
                <div class="flex items-center space-x-4">
                    <button onclick="window.close()" class="px-4 py-2 text-gray-600 hover:text-gray-900 transition-colors duration-200">
                        å…³é—­
                    </button>
                    <a href="/" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">
                        è¿”å›é¦–é¡µ
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹ -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- è‚¡ç¥¨ä¿¡æ¯å¡ç‰‡ -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 id="stockSymbol" class="text-2xl font-bold text-gray-900">-</h2>
                    <p id="stockName" class="text-gray-600">åŠ è½½ä¸­...</p>
                </div>
                <div class="text-right">
                    <p id="currentPrice" class="text-3xl font-bold text-gray-900">-</p>
                    <p id="priceChange" class="text-lg">-</p>
                </div>
            </div>
            
            <!-- åŸºæœ¬ä¿¡æ¯ - å‚è€ƒé›ªçƒé¡µé¢å¸ƒå±€ -->
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-3 mt-4 text-sm">
                <div class="text-center p-2 bg-gray-50 rounded-lg">
                    <p class="text-gray-500">ä»Šå¼€</p>
                    <p id="openPrice" class="font-semibold text-gray-900">-</p>
                </div>
                <div class="text-center p-2 bg-gray-50 rounded-lg">
                    <p class="text-gray-500">æœ€é«˜</p>
                    <p id="highPrice" class="font-semibold text-red-600">-</p>
                </div>
                <div class="text-center p-2 bg-gray-50 rounded-lg">
                    <p class="text-gray-500">æœ€ä½</p>
                    <p id="lowPrice" class="font-semibold text-green-600">-</p>
                </div>
                <div class="text-center p-2 bg-gray-50 rounded-lg">
                    <p class="text-gray-500">æˆäº¤é‡</p>
                    <p id="volume" class="font-semibold text-gray-900">-</p>
                </div>
                <div class="text-center p-2 bg-gray-50 rounded-lg">
                    <p class="text-gray-500">æˆäº¤é¢</p>
                    <p id="turnover" class="font-semibold text-gray-900">-</p>
                </div>
                <div class="text-center p-2 bg-gray-50 rounded-lg">
                    <p class="text-gray-500">æŒ¯å¹…</p>
                    <p id="amplitude" class="font-semibold text-gray-900">-</p>
                </div>
                <div class="text-center p-2 bg-gray-50 rounded-lg">
                    <p class="text-gray-500">æ¢æ‰‹ç‡</p>
                    <p id="turnoverRate" class="font-semibold text-gray-900">-</p>
                </div>
                <div class="text-center p-2 bg-gray-50 rounded-lg">
                    <p class="text-gray-500">æ˜¨æ”¶</p>
                    <p id="previousClose" class="font-semibold text-gray-900">-</p>
                </div>
            </div>
            
            <!-- æ›´å¤šè‚¡ç¥¨ä¿¡æ¯ -->
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 mt-3 text-sm">
                <div class="text-center p-2 bg-blue-50 rounded-lg">
                    <p class="text-gray-500">æ€»å¸‚å€¼</p>
                    <p id="marketCap" class="font-semibold text-gray-900">-</p>
                </div>
                <div class="text-center p-2 bg-blue-50 rounded-lg">
                    <p class="text-gray-500">æµé€šå€¼</p>
                    <p id="floatCap" class="font-semibold text-gray-900">-</p>
                </div>
                <div class="text-center p-2 bg-blue-50 rounded-lg">
                    <p class="text-gray-500">å¸‚ç›ˆç‡(TTM)</p>
                    <p id="peRatio" class="font-semibold text-gray-900">-</p>
                </div>
                <div class="text-center p-2 bg-blue-50 rounded-lg">
                    <p class="text-gray-500">å¸‚å‡€ç‡</p>
                    <p id="pbRatio" class="font-semibold text-gray-900">-</p>
                </div>
                <div class="text-center p-2 bg-blue-50 rounded-lg">
                    <p class="text-gray-500">æ¯è‚¡æ”¶ç›Š</p>
                    <p id="eps" class="font-semibold text-gray-900">-</p>
                </div>
                <div class="text-center p-2 bg-blue-50 rounded-lg">
                    <p class="text-gray-500">è‚¡æ¯ç‡</p>
                    <p id="dividendYield" class="font-semibold text-gray-900">-</p>
                </div>
            </div>
        </div>

        <!-- AIæ™ºèƒ½åˆ†æ - å…¨å®½æ˜¾ç¤º -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h3 class="text-lg font-semibold mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                </svg>
                AIæ™ºèƒ½åˆ†æ
            </h3>
            <section id="aiAnalysis" class="markdown-body-ai px-6 py-8 bg-white rounded-xl shadow-xl">
  <article class="max-w-4xl mx-auto space-y-10">
  <div class="analysis-container space-y-8">
                <div class="flex items-center justify-center py-8">
                    <div class="loading w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full"></div>
                    <span class="ml-2">åˆ†æä¸­...</span>
                </div>
            </div>
        </div>

        <!-- åˆ†æç»“æœ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- äº¤æ˜“ä¿¡å· -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    äº¤æ˜“ä¿¡å·
                </h3>
                <div id="tradingSignals" class="space-y-3">
                    <div class="flex items-center justify-center py-8">
                        <div class="loading w-6 h-6 border-2 border-yellow-600 border-t-transparent rounded-full"></div>
                        <span class="ml-2">è®¡ç®—ä¸­...</span>
                    </div>
                </div>
            </div>

            <!-- æŠ€æœ¯æŒ‡æ ‡ -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    æŠ€æœ¯æŒ‡æ ‡
                </h3>
                <div id="technicalIndicators" class="space-y-3">
                    <div class="flex items-center justify-center py-8">
                        <div class="loading w-6 h-6 border-2 border-green-600 border-t-transparent rounded-full"></div>
                        <span class="ml-2">è®¡ç®—ä¸­...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Kçº¿å›¾ -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h3 class="text-lg font-semibold mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                </svg>
                Kçº¿å›¾è¡¨
            </h3>
            <div id="stockChart" style="height: 400px;"></div>
        </div>

        <!-- å›æµ‹ç»“æœ -->
        <div id="backtestResults" class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex items-center justify-center py-8">
                <div class="loading w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full"></div>
                <span class="ml-2">è®¡ç®—ä¸­...</span>
            </div>
        </div>

        <!-- é£é™©æŠ¥å‘Š -->
        <div id="riskReport" class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex items-center justify-center py-8">
                <div class="loading w-6 h-6 border-2 border-red-600 border-t-transparent rounded-full"></div>
                <span class="ml-2">è®¡ç®—ä¸­...</span>
            </div>
        </div>
    </div>

    <script>
        // è·å–URLå‚æ•°
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // æ ¼å¼åŒ–æ•°å­—
        function formatNumber(num) {
            if (num === null || num === undefined) return '-';
            if (num >= 100000000) {
                return (num / 100000000).toFixed(2) + 'äº¿';
            } else if (num >= 10000) {
                return (num / 10000).toFixed(2) + 'ä¸‡';
            }
            return num.toLocaleString();
        }

        // æ ¼å¼åŒ–ä»·æ ¼å˜åŒ–
        function formatPriceChange(change, changePercent) {
            if (change === null || change === undefined) return '-';
            const changeStr = change >= 0 ? `+${change.toFixed(2)}` : change.toFixed(2);
            const percentStr = changePercent >= 0 ? `+${changePercent.toFixed(2)}%` : `${changePercent.toFixed(2)}%`;
            const colorClass = change >= 0 ? 'text-red-600' : 'text-green-600';
            return `<span class="${colorClass}">${changeStr} (${percentStr})</span>`;
        }

        // åŠ è½½è‚¡ç¥¨åˆ†æ
        async function loadStockAnalysis(symbol) {
            if (!symbol) {
                document.getElementById('aiAnalysis').innerHTML = '<p class="text-red-600">æœªæŒ‡å®šè‚¡ç¥¨ä»£ç </p>';
                return;
            }

            try {
                // æ›´æ–°é¡µé¢æ ‡é¢˜
                document.title = `${symbol} - ä¸ªè‚¡åˆ†æ`;
                document.getElementById('stockSymbol').textContent = symbol;

                // è°ƒç”¨åˆ†æAPI
                const response = await fetch('http://localhost:8003/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ symbol: symbol })
                });

                const data = await response.json();

                if (data.success && data.data && data.data.success) {
                    const result = data.data;
                    
                    // æ›´æ–°åŸºæœ¬ä¿¡æ¯
                    if (result.stock_info) {
                        const info = result.stock_info;
                        document.getElementById('stockName').textContent = info.longName || symbol;
                        document.getElementById('currentPrice').textContent = result.latest_price ? `Â¥${result.latest_price.toFixed(2)}` : '-';
                        document.getElementById('priceChange').innerHTML = '-'; // æš‚æ—¶æ˜¾ç¤ºä¸º-
                        document.getElementById('openPrice').textContent = '-';
                        document.getElementById('highPrice').textContent = '-';
                        document.getElementById('lowPrice').textContent = '-';
                        document.getElementById('volume').textContent = '-';
                    }

                    // æ›´æ–°AIåˆ†æ - ä½¿ç”¨markedè§£æmarkdownï¼Œå…¨å®½æ˜¾ç¤º
                    if (result.ai_analysis) {
                        const parsedMarkdown = marked.parse(result.ai_analysis);
                        document.getElementById('aiAnalysis').innerHTML = `
                            <div class="fade-in">
                                <div class="prose max-w-none">
                                    ${parsedMarkdown}
                                </div>
                            </div>
                        `;
                    } else {
                        document.getElementById('aiAnalysis').innerHTML = '<p class="text-gray-500">æš‚æ— åˆ†ææ•°æ®</p>';
                    }

                    // æ›´æ–°è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯ï¼ˆé¡¶éƒ¨åŒºåŸŸï¼‰
                    const stockInfo = result.stock_info;
                    if (stockInfo) {
                        // åŸºç¡€ä»·æ ¼ä¿¡æ¯
                        document.getElementById('openPrice').textContent = stockInfo.open_price ? formatPriceChange(stockInfo.open_price) : '-';
                        document.getElementById('highPrice').textContent = stockInfo.high_price ? formatPriceChange(stockInfo.high_price) : '-';
                        document.getElementById('lowPrice').textContent = stockInfo.low_price ? formatPriceChange(stockInfo.low_price) : '-';
                        document.getElementById('volume').textContent = stockInfo.volume ? formatNumber(stockInfo.volume) : '-';
                        document.getElementById('turnover').textContent = stockInfo.turnover ? formatNumber(stockInfo.turnover) : '-';
                        document.getElementById('amplitude').textContent = stockInfo.amplitude ? stockInfo.amplitude + '%' : '-';
                        document.getElementById('turnoverRate').textContent = stockInfo.turnover_rate ? stockInfo.turnover_rate + '%' : '-';
                        document.getElementById('previousClose').textContent = stockInfo.previous_close ? formatPriceChange(stockInfo.previous_close) : '-';
                        
                        // æ›´å¤šè‚¡ç¥¨ä¿¡æ¯
                        document.getElementById('marketCap').textContent = stockInfo.market_cap ? formatNumber(stockInfo.market_cap) : '-';
                        document.getElementById('floatCap').textContent = stockInfo.float_cap ? formatNumber(stockInfo.float_cap) : '-';
                        document.getElementById('peRatio').textContent = stockInfo.pe_ratio || '-';
                        document.getElementById('pbRatio').textContent = stockInfo.pb_ratio || '-';
                        document.getElementById('eps').textContent = stockInfo.eps || '-';
                        document.getElementById('dividendYield').textContent = stockInfo.dividend_yield ? stockInfo.dividend_yield + '%' : '-';
                    }

                    // æ›´æ–°äº¤æ˜“ä¿¡å· - å¤„ç†ä¸åŒçš„æ•°æ®ç»“æ„
                    if (result.signals && result.signals.length > 0) {
                        const signalsHtml = result.signals.map(signal => {
                            // å¤„ç†ä¸åŒçš„å­—æ®µåæ ¼å¼
                            const signalType = signal.signal_type || signal.type || 'hold';
                            const signalName = signal.signal_name || signal.name || 'äº¤æ˜“ä¿¡å·';
                            const confidence = signal.confidence || signal.score || 0;
                            const description = signal.description || signal.reason || '';
                            const price = signal.price || signal.signal_price || null;
                            const signalDate = signal.date || signal.signal_date || '';
                            
                            const signalClass = signalType.toLowerCase() === 'buy' ? 'bg-green-100 border-green-300' : 
                                              signalType.toLowerCase() === 'sell' ? 'bg-red-100 border-red-300' : 
                                              'bg-yellow-100 border-yellow-300';
                            const signalIcon = signalType.toLowerCase() === 'buy' ? 'â†‘' : 
                                             signalType.toLowerCase() === 'sell' ? 'â†“' : 'âš ';
                            const signalTextClass = signalType.toLowerCase() === 'buy' ? 'text-green-800' : 
                                                  signalType.toLowerCase() === 'sell' ? 'text-red-800' : 
                                                  'text-yellow-800';
                            
                            let priceInfo = '';
                            if (price !== null && price !== undefined) {
                                const priceColorClass = signalType.toLowerCase() === 'buy' ? 'text-green-600' : 
                                                       signalType.toLowerCase() === 'sell' ? 'text-red-600' : 
                                                       'text-yellow-600';
                                priceInfo = `<span class="${priceColorClass} font-semibold"> @ Â¥${price.toFixed(2)}</span>`;
                            }
                            
                            let dateInfo = '';
                            if (signalDate) {
                                dateInfo = `<div class="text-xs text-gray-500 mt-1">${signalDate}</div>`;
                            }
                            
                            return `
                                <div class="p-3 rounded-lg border ${signalClass}">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <span class="text-lg font-bold mr-2">${signalIcon}</span>
                                            <span class="font-semibold ${signalTextClass}">${signalName}</span>
                                            ${priceInfo}
                                        </div>
                                        <span class="text-sm opacity-75">${confidence}%</span>
                                    </div>
                                    <p class="text-sm mt-1 opacity-90 ${signalTextClass}">${description}</p>
                                    ${dateInfo}
                                </div>
                            `;
                        }).join('');
                        document.getElementById('tradingSignals').innerHTML = signalsHtml;
                    } else {
                        document.getElementById('tradingSignals').innerHTML = '<p class="text-gray-500 text-center py-4">æš‚æ— äº¤æ˜“ä¿¡å·</p>';
                    }

                    // æ›´æ–°æŠ€æœ¯æŒ‡æ ‡ï¼ˆåªä¿ç•™çº¯æŠ€æœ¯æŒ‡æ ‡ï¼Œå–æœ€æ–°å€¼å¹¶ä¼˜åŒ–ç²¾åº¦ï¼‰
                    const technicalData = result.technical_data;
                    
                    // å®šä¹‰å…è®¸çš„æŠ€æœ¯æŒ‡æ ‡åˆ—è¡¨ï¼Œåªä¿ç•™çœŸæ­£çš„æŠ€æœ¯æŒ‡æ ‡
                    const allowedTechnicalIndicators = [
                        'MA5', 'MA10', 'MA20', 'MA30', 'MA60', 'MA120', 'MA240',
                        'RSI', 'RSI6', 'RSI12', 'RSI24',
                        'MACD', 'MACD_Signal', 'MACD_Hist', 'MACD_DIFF', 'MACD_DEA',
                        'KDJ_K', 'KDJ_D', 'KDJ_J',
                        'BB_Upper', 'BB_Lower', 'BB_Middle', 'BB_Bandwidth',
                        'BOLL_Upper', 'BOLL_Lower', 'BOLL_Middle', 'BOLL_Bandwidth',
                        'WILLR', 'CCI', 'SAR', 'DMA', 'EXPMA', 'TRIX', 'BIAS', 'ROC',
                        'MIKE_S', 'MIKE_R', 'MIKE_WS', 'MIKE_WR'
                    ];
                    
                    const indicatorsHtml = Object.entries(technicalData)
                        .filter(([key]) => {
                            // åªå…è®¸æ˜ç¡®çš„æŠ€æœ¯æŒ‡æ ‡ï¼Œæ’é™¤æ‰€æœ‰å…¶ä»–æ•°æ®
                            return allowedTechnicalIndicators.includes(key);
                        })
                        .map(([key, value]) => {
                            const displayName = {
                                'ma5': 'MA5',
                                'ma10': 'MA10', 
                                'ma20': 'MA20',
                                'ma30': 'MA30',
                                'ma60': 'MA60',
                                'rsi': 'RSI',
                                'rsi6': 'RSI6',
                                'rsi12': 'RSI12',
                                'rsi24': 'RSI24',
                                'macd': 'MACD',
                                'macd_diff': 'MACD-DIFF',
                                'macd_dea': 'MACD-DEA',
                                'kdj_k': 'KDJ-K',
                                'kdj_d': 'KDJ-D',
                                'kdj_j': 'KDJ-J',
                                'boll_upper': 'BOLLä¸Šè½¨',
                                'boll_middle': 'BOLLä¸­è½¨',
                                'boll_lower': 'BOLLä¸‹è½¨',
                                'boll_bandwidth': 'BOLLå¸¦å®½',
                                'willr': 'WILLR',
                                'cci': 'CCI',
                                'sar': 'SAR',
                                'dma': 'DMA',
                                'expma': 'EXPMA',
                                'trix': 'TRIX',
                                'bias': 'BIAS',
                                'roc': 'ROC',
                                'mike_s': 'MIKE-S',
                                'mike_r': 'MIKE-R',
                                'mike_ws': 'MIKE-WS',
                                'mike_wr': 'MIKE-WR'
                            }[key.toLowerCase()] || key.toUpperCase();
                            
                            let displayValue = 'N/A';
                            // å–æœ€æ–°å€¼ï¼ˆæ•°ç»„æœ€åä¸€ä¸ªæˆ–å•ä¸ªæ•°å€¼ï¼‰
                            const latestValue = Array.isArray(value) && value.length ? value[value.length - 1] : value;
                            if (typeof latestValue === 'number') {
                                const k = key.toLowerCase();
                                if (k.includes('rsi') || k.includes('willr') || k.includes('bias')) {
                                    displayValue = latestValue.toFixed(1) + '%';
                                } else if (k.includes('macd')) {
                                    displayValue = latestValue.toFixed(3);
                                } else if (k.includes('boll') || k.includes('ma') || k.includes('kdj')) {
                                    displayValue = latestValue.toFixed(2);
                                } else if (latestValue > 1000) {
                                    displayValue = latestValue.toFixed(0);
                                } else {
                                    displayValue = latestValue.toFixed(2);
                                }
                            } else if (typeof latestValue === 'string') {
                                displayValue = latestValue;
                            }
                            
                            return `
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <p class="text-sm text-gray-600">${displayName}</p>
                                    <p class="font-semibold">${displayValue}</p>
                                </div>
                            `;
                        }).join('');
                    
                    document.getElementById('technicalIndicators').innerHTML = indicatorsHtml || '<p class="text-gray-500 text-center py-4">æš‚æ— æŠ€æœ¯æŒ‡æ ‡æ•°æ®</p>';

                    // æ¸²æŸ“Kçº¿å›¾
                    if (result.chart_data) {
                        renderStockChart(result.chart_data);
                    }
                    
                    // æ˜¾ç¤ºå›æµ‹ç»“æœ
                    if (result.backtest) {
                        displayBacktestResults(result.backtest);
                    }
                    
                    // æ˜¾ç¤ºé£é™©æŠ¥å‘Š
                    if (result.risk_report) {
                        displayRiskReport(result.risk_report);
                    }
                } else {
                    document.getElementById('aiAnalysis').innerHTML = `<p class="text-red-600">åˆ†æå¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}</p>`;
                }
            } catch (error) {
                console.error('åŠ è½½åˆ†æå¤±è´¥:', error);
                document.getElementById('aiAnalysis').innerHTML = '<p class="text-red-600">ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•</p>';
            }
        }

        // æ¸²æŸ“Kçº¿å›¾
        function renderStockChart(chartData) {
            console.log('=== ä¿®å¤ç‰ˆrenderStockChartå‡½æ•° ===');
            const container = document.getElementById('stockChart');
            
            // é”€æ¯ç°æœ‰å›¾è¡¨å®ä¾‹é¿å…å†²çª
            const existingChart = echarts.getInstanceByDom(container);
            if (existingChart) {
                existingChart.dispose();
            }
            
            const chart = echarts.init(container);

            // å‡†å¤‡æ•°æ®
            const dates = (chartData.kline || []).map(item => item.date);
            const kValues = (chartData.kline || []).map(item => [item.open, item.close, item.low, item.high]);
            
            // å‡†å¤‡å›æµ‹æ•°æ®
            const portfolioData = chartData.portfolio || [];
            const tradeMarkers = (chartData.trade_markers || []).map(marker => ({
                date: marker.date,
                type: marker.type.toUpperCase(), // ç¡®ä¿ç±»å‹ä¸ºå¤§å†™
                price: parseFloat(marker.price) // ç¡®ä¿ä»·æ ¼ä¸ºæ•°å­—
            }));
            
            const portfolioValues = portfolioData.map(item => item.value);
            const buySignals = tradeMarkers.filter(s => s.type === 'BUY');
            const sellSignals = tradeMarkers.filter(s => s.type === 'SELL');
            
            console.log('äº¤æ˜“ä¿¡å·ç»Ÿè®¡:', {
                totalMarkers: tradeMarkers.length,
                buySignals: buySignals.length,
                sellSignals: sellSignals.length
            });

            // åˆ›å»ºä¹°å…¥ä¿¡å·æ•°æ®ç‚¹ - ç¡®ä¿æ˜ å°„æ­£ç¡®
            const buySignalData = buySignals.map(signal => {
                console.log(`ä¹°å…¥ä¿¡å·: æ—¥æœŸ=${signal.date}, ä»·æ ¼=${signal.price}`);
                return [signal.date, signal.price];
            });
            
            // åˆ›å»ºå–å‡ºä¿¡å·æ•°æ®ç‚¹ - ç¡®ä¿æ˜ å°„æ­£ç¡®
            const sellSignalData = sellSignals.map(signal => {
                console.log(`å–å‡ºä¿¡å·: æ—¥æœŸ=${signal.date}, ä»·æ ¼=${signal.price}`);
                return [signal.date, signal.price];
            });

            const option = {
                backgroundColor: '#fff',
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' },
                    formatter: function(params) {
                        let result = `<strong>${params[0].name}</strong><br/>`;
                        params.forEach(param => {
                            if (param.seriesName === 'Kçº¿') {
                                result += `å¼€ç›˜: ${param.data[0]}<br/>æ”¶ç›˜: ${param.data[1]}<br/>æœ€ä½: ${param.data[2]}<br/>æœ€é«˜: ${param.data[3]}<br/>`;
                            } else if (param.seriesName === 'ä¹°å…¥ä¿¡å·') {
                                result += `<span style="color: #22c55e">ğŸ”º ä¹°å…¥ä¿¡å·: ${param.data[1]}å…ƒ</span><br/>`;
                            } else if (param.seriesName === 'å–å‡ºä¿¡å·') {
                                result += `<span style="color: #ef4444">ğŸ”» å–å‡ºä¿¡å·: ${param.data[1]}å…ƒ</span><br/>`;
                            } else if (param.seriesName === 'ç»„åˆå‡€å€¼') {
                                result += `ç»„åˆå‡€å€¼: ${param.data}<br/>`;
                            }
                        });
                        return result;
                    }
                },
                legend: {
                    data: ['Kçº¿', 'ç»„åˆå‡€å€¼', 'ä¹°å…¥ä¿¡å·', 'å–å‡ºä¿¡å·']
                },
                grid: {
                    left: '10%',
                    right: '15%',
                    bottom: '15%'
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    scale: true,
                    boundaryGap: false,
                    axisLine: { onZero: false },
                    splitLine: { show: false },
                    min: 'dataMin',
                    max: 'dataMax'
                },
                yAxis: [
                    {
                        type: 'value',
                        name: 'è‚¡ä»· (å…ƒ)',
                        position: 'left',
                        scale: true,
                        splitArea: { show: true },
                        axisLabel: {
                            formatter: '{value}å…ƒ'
                        }
                    },
                    {
                        type: 'value',
                        name: 'ç»„åˆå‡€å€¼',
                        position: 'right',
                        scale: true,
                        splitArea: { show: false },
                        axisLabel: {
                            formatter: function(value) {
                                if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
                                if (value >= 1000) return (value / 1000).toFixed(1) + 'K';
                                return value.toFixed(0);
                            }
                        }
                    }
                ],
                dataZoom: [
                    {
                        type: 'inside',
                        start: 50,
                        end: 100
                    },
                    {
                        show: true,
                        type: 'slider',
                        top: '90%',
                        start: 50,
                        end: 100
                    }
                ],
                series: [
                    {
                        name: 'Kçº¿',
                        type: 'candlestick',
                        data: kValues,
                        yAxisIndex: 0,
                        itemStyle: {
                            color: '#ef4444',
                            color0: '#22c55e',
                            borderColor: '#ef4444',
                            borderColor0: '#22c55e'
                        }
                    },
                    {
                        name: 'ç»„åˆå‡€å€¼',
                        type: 'line',
                        data: portfolioValues,
                        yAxisIndex: 1,
                        smooth: true,
                        lineStyle: {
                            color: '#3b82f6',
                            width: 2
                        },
                        symbol: 'none'
                    },
                    {
                        name: 'ä¹°å…¥ä¿¡å·',
                        type: 'scatter',
                        data: buySignalData,
                        yAxisIndex: 0,
                        symbol: 'triangle',
                        symbolSize: 25,
                        itemStyle: {
                            color: '#22c55e'
                        },
                        emphasis: {
                            itemStyle: {
                                color: '#16a34a',
                                borderColor: '#fff',
                                borderWidth: 2
                            }
                        }
                    },
                    {
                        name: 'å–å‡ºä¿¡å·',
                        type: 'scatter',
                        data: sellSignalData,
                        yAxisIndex: 0,
                        symbol: 'triangle-down',
                        symbolSize: 25,
                        itemStyle: {
                            color: '#ef4444'
                        },
                        emphasis: {
                            itemStyle: {
                                color: '#dc2626',
                                borderColor: '#fff',
                                borderWidth: 2
                            }
                        }
                    }
                ]
            };

            chart.setOption(option);
            
            // å¼ºåˆ¶æ˜¾ç¤ºæ‰€æœ‰ç³»åˆ—
            chart.setOption({
                legend: {
                    selected: {
                        'Kçº¿': true,
                        'ç»„åˆå‡€å€¼': true,
                        'ä¹°å…¥ä¿¡å·': true,
                        'å–å‡ºä¿¡å·': true
                    }
                }
            });

            // å“åº”å¼è°ƒæ•´
            window.addEventListener('resize', () => {
                chart.resize();
            });
            
            console.log('ä¿®å¤ç‰ˆå›¾è¡¨æ¸²æŸ“å®Œæˆ');
            console.log('ä¹°å…¥ä¿¡å·æ•°æ®:', buySignalData);
            console.log('å–å‡ºä¿¡å·æ•°æ®:', sellSignalData);
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            const symbol = getUrlParameter('symbol');
            loadStockAnalysis(symbol);
        });

        // æ˜¾ç¤ºå›æµ‹ç»“æœ
        function displayBacktestResults(results) {
            const container = document.getElementById('backtestResults');
            if (!container) return;
            
            // è·å–æ€§èƒ½æŒ‡æ ‡æ•°æ®
            const metrics = results.performance_metrics || results;
            
            let html = `
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-4">å›æµ‹ç»“æœ</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center">
                            <p class="text-sm text-gray-600">æ€»æ”¶ç›Šç‡</p>
                            <p class="text-xl font-bold ${metrics.total_return >= 0 ? 'text-green-600' : 'text-red-600'}">
                                ${metrics.total_return ? metrics.total_return.toFixed(2) : '0.00'}%
                            </p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-600">å¹´åŒ–æ”¶ç›Šç‡</p>
                            <p class="text-xl font-bold ${metrics.annualized_return >= 0 ? 'text-green-600' : 'text-red-600'}">
                                ${metrics.annualized_return ? metrics.annualized_return.toFixed(2) : '0.00'}%
                            </p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-600">æœ€å¤§å›æ’¤</p>
                            <p class="text-xl font-bold text-red-600">
                                ${metrics.max_drawdown ? metrics.max_drawdown.toFixed(2) : '0.00'}%
                            </p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-600">å¤æ™®æ¯”ç‡</p>
                            <p class="text-xl font-bold">
                                ${metrics.sharpe_ratio ? metrics.sharpe_ratio.toFixed(2) : '0.00'}
                            </p>
                        </div>
                    </div>
                    
                    ${metrics.win_rate !== undefined ? `
                    <div class="mt-4 pt-4 border-t">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">èƒœç‡</p>
                                <p class="font-semibold">${metrics.win_rate.toFixed(2)}%</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">äº¤æ˜“æ¬¡æ•°</p>
                                <p class="font-semibold">${metrics.total_trades || 0}</p>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
            
            container.innerHTML = html;
        }

        // æ˜¾ç¤ºé£é™©æŠ¥å‘Š
        function displayRiskReport(riskReport) {
            const container = document.getElementById('riskReport');
            if (!container) return;
            
            const riskColor = getRiskColor(riskReport.risk_level);
            
            let html = `
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-4">é£é™©æŠ¥å‘Š</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">é£é™©ç­‰çº§</span>
                            <span class="px-3 py-1 rounded-full text-sm font-medium ${riskColor}">
                                ${riskReport.risk_level}
                            </span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">é£é™©è¯„åˆ†</span>
                            <span class="font-semibold">${riskReport.risk_score}/100</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">å»ºè®®ä»“ä½</span>
                            <span class="font-semibold">${riskReport.suggested_position || 'ä¸­ç­‰'}</span>
                        </div>
                        ${riskReport.risk_factors ? `
                        <div class="pt-4 border-t">
                            <p class="text-sm text-gray-600 mb-2">ä¸»è¦é£é™©å› ç´ </p>
                            <ul class="text-sm space-y-1">
                                ${riskReport.risk_factors.map(factor => `<li>â€¢ ${factor}</li>`).join('')}
                            </ul>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // è·å–é£é™©é¢œè‰²
        function getRiskColor(riskLevel) {
            switch (riskLevel) {
                case 'ä½é£é™©':
                    return 'bg-green-100 text-green-800';
                case 'ä¸­ç­‰é£é™©':
                    return 'bg-yellow-100 text-yellow-800';
                case 'é«˜é£é™©':
                    return 'bg-red-100 text-red-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }
    </script>
</body>
</html>