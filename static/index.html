<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股票分析系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com/?plugins=typography"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    <style>
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- 头部 -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-4">智能股票分析系统</h1>
            <p class="text-gray-600">基于大模型的股票技术分析与投资建议</p>
        </div>

        <!-- 搜索区域 -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex flex-col md:flex-row gap-4 items-center">
                <input 
                    type="text" 
                    id="stockInput" 
                    placeholder="输入股票代码（如：600036.SH）" 
                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                <button 
                    onclick="analyzeStock()" 
                    class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                    分析股票
                </button>
                <div id="loading" class="hidden">
                    <div class="loading"></div>
                </div>
            </div>
            
            <!-- 热门股票 -->
            <div class="mt-4">
                <p class="text-sm text-gray-600 mb-2">热门股票：</p>
                <div id="popularStocks" class="flex flex-wrap gap-2">
                    <!-- 动态加载 -->
                </div>
            </div>
        </div>

        <!-- 智能选股榜单 -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-xl font-semibold text-gray-800">智能选股榜单</h2>
                <div class="flex items-center gap-2">
                    <label for="sortMode" class="text-sm text-gray-600">排序</label>
                    <select id="sortMode" class="px-2 py-1 border border-gray-300 rounded text-sm" onchange="onSortModeChange()">
                        <option value="expected_return_desc">按预期收益</option>
                        <option value="prob_up_desc">按30天上涨概率</option>
                        <option value="default">默认</option>
                    </select>
                    <button onclick="loadStockPicks()" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">刷新榜单</button>
                    <button onclick="refreshDataAndReloadPicks()" class="px-3 py-1 bg-gray-700 text-white rounded hover:bg-gray-800 text-sm">增量刷新数据</button>
                </div>
            </div>
            <div id="stockPicksLoading" class="hidden mb-3"><div class="loading"></div></div>
            <div id="stockPicks" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
        </div>

        <!-- 结果显示区域 -->
        <div id="result" class="hidden bg-white rounded-lg shadow-md p-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- 基本信息 -->
                <div class="bg-blue-50 rounded-lg p-4">
                    <h3 class="text-lg font-semibold mb-3 text-blue-800">股票基本信息</h3>
                    <div id="basicInfo"></div>
                </div>

                <!-- 技术指标 -->
                <div class="bg-green-50 rounded-lg p-4">
                    <h3 class="text-lg font-semibold mb-3 text-green-800">技术指标</h3>
                    <div id="technicalInfo"></div>
                </div>

                <!-- AI分析 -->
                <div class="lg:col-span-2 bg-purple-50 rounded-lg p-4">
                    <h3 class="text-lg font-semibold mb-3 text-purple-800">AI投资建议</h3>
                    <div id="aiAnalysis" class="prose max-w-none"></div>
                </div>

                <!-- 交易信号 -->
                <div class="lg:col-span-2 bg-yellow-50 rounded-lg p-4">
                    <h3 class="text-lg font-semibold mb-3 text-yellow-800">近期交易信号</h3>
                    <div id="signals"></div>
                </div>

                <!-- K线图 -->
                <div class="lg:col-span-2 bg-white rounded-lg p-4 border border-gray-200">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800">K线图与技术分析</h3>
                    <div id="chartContainer" style="height: 400px;">
                        <div id="stockChart" style="width:100%;height:100%;"></div>
                    </div>
                </div>

                <!-- 回测结果 -->
                <div class="lg:col-span-1 bg-blue-50 rounded-lg p-4">
                    <h3 class="text-lg font-semibold mb-3 text-blue-800">回测结果</h3>
                    <div id="backtestResults"></div>
                </div>

                <!-- 风险报告 -->
                <div class="lg:col-span-1 bg-red-50 rounded-lg p-4">
                    <h3 class="text-lg font-semibold mb-3 text-red-800">风险分析</h3>
                    <div id="riskReport"></div>
                </div>
            </div>
        </div>

        <!-- 错误信息 -->
        <div id="error" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
            <div class="text-red-800" id="errorMessage"></div>
        </div>
    </div>

    <script>
        // 加载热门股票
        async function loadPopularStocks() {
            try {
                const response = await fetch('/api/popular-stocks');
                const data = await response.json();
                
                const container = document.getElementById('popularStocks');
                container.innerHTML = '';
                
                data.stocks.forEach(stock => {
                    const button = document.createElement('button');
                    button.className = 'px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300';
                    button.textContent = `${stock.name} (${stock.symbol})`;
                    button.onclick = () => {
                        document.getElementById('stockInput').value = stock.symbol;
                        analyzeStock();
                    };
                    container.appendChild(button);
                });
            } catch (error) {
                console.error('加载热门股票失败:', error);
            }
        }

        // 分析股票
        async function analyzeStock() {
            let symbol = document.getElementById('stockInput').value.trim();
            if (!symbol) {
                showError('请输入股票代码');
                return;
            }
            
            // 自动添加股票代码后缀
            if (/^\d{6}$/.test(symbol)) {
                // 6位数字：6 开头默认为上交所，其余默认为深交所
                symbol = symbol.startsWith('6') ? symbol + '.SH' : symbol + '.SZ';
            }

            // 显示加载中
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('result').classList.add('hidden');
            document.getElementById('error').classList.add('hidden');

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ symbol: symbol })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || '分析失败');
                }

                if (!data.data.success) {
                    throw new Error(data.data.error);
                }

                displayResults(data.data);
                
            } catch (error) {
                showError(error.message);
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        // 显示结果
        function displayResults(data) {
            // 基本信息
            document.getElementById('basicInfo').innerHTML = `
                <p><strong>股票名称：</strong>${data.stock_info.longName || data.stock_info.symbol}</p>
                <p><strong>当前价格：</strong>${data.latest_price.toFixed(2)}</p>
                <p><strong>行业：</strong>${data.stock_info.industry || 'N/A'}</p>
                <p><strong>市值：</strong>${data.stock_info.marketCap ? (data.stock_info.marketCap / 1e8).toFixed(2) + '亿元' : 'N/A'}</p>
            `;

            // 技术指标
            const techData = data.technical_data;
            document.getElementById('technicalInfo').innerHTML = `
                <p><strong>5日均线：</strong>${techData.MA5[Object.keys(techData.MA5)[0]].toFixed(2)}</p>
                <p><strong>20日均线：</strong>${techData.MA20[Object.keys(techData.MA20)[0]].toFixed(2)}</p>
                <p><strong>RSI：</strong>${techData.RSI[Object.keys(techData.RSI)[0]].toFixed(2)}</p>
                <p><strong>MACD：</strong>${techData.MACD[Object.keys(techData.MACD)[0]].toFixed(4)}</p>
            `;

            // AI分析 - 使用marked.js解析markdown格式
            const aiAnalysisElement = document.getElementById('aiAnalysis');
            // 使用marked解析markdown为HTML
            try {
                // 确保marked已正确加载
                if (typeof marked === 'function') {
                    aiAnalysisElement.innerHTML = marked(data.ai_analysis);
                } else if (marked && typeof marked.parse === 'function') {
                    aiAnalysisElement.innerHTML = marked.parse(data.ai_analysis);
                } else {
                    // 如果marked不可用，回退到简单的换行处理
                    aiAnalysisElement.innerHTML = data.ai_analysis.replace(/\n/g, '<br>');
                }
            } catch (error) {
                console.error('Markdown解析错误:', error);
                // 出错时回退到简单的换行处理
                aiAnalysisElement.innerHTML = data.ai_analysis.replace(/\n/g, '<br>');
            }
            // 移除之前的CSS类，使用Tailwind Typography插件的prose类
            aiAnalysisElement.classList.remove('whitespace-pre-line', 'leading-relaxed');

            // 交易信号
            const signalsHtml = data.signals.length > 0 ? 
                data.signals.map(signal => `
                    <div class="p-2 mb-2 rounded ${signal.type === 'BUY' ? 'bg-green-100' : (signal.type === 'SELL' ? 'bg-red-100' : 'bg-yellow-100')}">
                        <strong>${signal.date}</strong> - 
                        <span class="${signal.type === 'BUY' ? 'text-green-800' : (signal.type === 'SELL' ? 'text-red-800' : 'text-yellow-800')}">
                            ${signal.type} @ ${signal.price.toFixed(2)}
                        </span>
                        <br><small>${signal.reason}</small>
                    </div>
                `).join('') :
                '<p>近期无交易信号</p>';
            
            document.getElementById('signals').innerHTML = signalsHtml;

            // 先显示结果容器，再渲染图表，避免在隐藏容器中初始化 ECharts 导致尺寸为 0
            document.getElementById('result').classList.remove('hidden');

            // 显示K线图（在容器可见后渲染）
            if (data.chart_data && data.chart_data.kline) {
                renderStockChart(data.chart_data);
            }

            // 显示回测结果
            if (data.backtest) {
                displayBacktestResults(data.backtest);
            }

            // 显示风险报告
            if (data.risk_report) {
                displayRiskReport(data.risk_report);
            }
        }

        // 显示错误
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('error').classList.remove('hidden');
        }

        // 渲染K线图
        // ECharts 实例
        let echartsInstance = null;

        function renderStockChart(chartData) {
            const container = document.getElementById('stockChart');

            // 销毁旧实例
            if (echartsInstance) {
                try { echartsInstance.dispose(); } catch (e) { /* ignore */ }
                echartsInstance = null;
            }

            echartsInstance = echarts.init(container);

            // 准备 K 线数据：使用 category x 轴（显式的日期数组）和 values 数组
            const dates = (chartData.kline || []).map(item => item.date);
            // ECharts K 线值顺序为 [open, close, low, high]
            const kValues = (chartData.kline || []).map(item => [item.open, item.close, item.low, item.high]);

            // 收盘价线：使用与 dates 索引对齐的纯数值数组（便于 dataZoom 基于索引工作）
            const closeLineData = (chartData.kline || []).map(item => item.close);

            // 组合净值：先构建日期->净值映射，再按 dates 顺序生成对齐数组（缺失用 null 填充）
            const portfolioMap = {};
            (chartData.portfolio || []).forEach(p => { if (p && p.date) portfolioMap[p.date] = p.value; });
            const portfolioData = dates.map(d => (portfolioMap[d] != null ? portfolioMap[d] : null));

            // 交易标记：使用 [index, price] 的格式，确保与类目轴索引对齐
            const buyData = [];
            const sellData = [];
            (chartData.trade_markers || []).forEach(t => {
                const idx = dates.indexOf(t.date);
                if (idx === -1) return; // skip markers outside the shown kline window
                const price = (t.price != null ? t.price : null);
                if (t.type && t.type.toUpperCase() === 'BUY') buyData.push([idx, price]);
                else if (t.type && t.type.toUpperCase() === 'SELL') sellData.push([idx, price]);
                else buyData.push([idx, price]);
            });

            const option = {
                backgroundColor: '#fff',
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' }
                },
                toolbox: {
                    feature: { saveAsImage: {} }
                },
                dataZoom: [
                    { type: 'inside', xAxisIndex: 0, throttle: 50 },
                    { type: 'slider', xAxisIndex: 0 }
                ],
                // 使用类目坐标轴并显式设置日期，使用索引对齐（boundaryGap=false 更适合时间序列）
                xAxis: { type: 'category', data: dates, boundaryGap: false },
                yAxis: [
                    { scale: true, name: '价格', position: 'left' },
                    { scale: true, name: '组合净值', position: 'right' }
                ],
                series: [
                    {
                        name: 'K线',
                        type: 'candlestick',
                        // 使用与 xAxis.data 对齐的值数组
                        data: kValues,
                        itemStyle: { color: '#ec0000', color0: '#00da3c', borderColor: '#8A0000', borderColor0: '#008F3D' }
                    },
                    {
                        name: '收盘价',
                        type: 'line',
                        // 与类目轴按索引对齐的纯数值数组
                        data: closeLineData,
                        smooth: true,
                        lineStyle: { color: '#4bc0c0' },
                        showSymbol: false,
                        yAxisIndex: 0
                    },
                    {
                        name: '组合净值',
                        type: 'line',
                        data: portfolioData,
                        smooth: true,
                        lineStyle: { color: '#ff9f40' },
                        showSymbol: false,
                        yAxisIndex: 1
                    },
                    {
                        name: '买入',
                        type: 'scatter',
                        // scatter 使用 [index, value]，索引对应 xAxis.data
                        data: buyData,
                        symbol: 'pin',
                        symbolSize: 20,
                        symbolOffset: [0, 15],
                        itemStyle: { color: '#00ff00' },
                        yAxisIndex: 0
                    },
                    {
                        name: '卖出',
                        type: 'scatter',
                        data: sellData,
                        symbol: 'pin',
                        symbolSize: 20,
                        symbolOffset: [0, -15],
                        itemStyle: { color: '#ff0000' },
                        yAxisIndex: 0
                    }
                ]
            };

            // 改进 tooltip：展示对应的日期（使用 dates 数组按 dataIndex 映射）
            option.tooltip.formatter = function (params) {
                if (!params || !params.length) return '';
                const idx = params[0].dataIndex;
                const date = dates[idx] || params[0].name || '';
                let txt = '<b>' + date + '</b><br/>';
                params.forEach(p => {
                    txt += p.seriesName + ': ' + (p.value != null ? (Array.isArray(p.value) ? p.value[1] : p.value) : '-') + '<br/>';
                });
                return txt;
            };

            echartsInstance.setOption(option);

            // 响应式
            window.addEventListener('resize', function() { try { echartsInstance.resize(); } catch (e) {} });
        }
        
        // 显示回测结果
        function displayBacktestResults(backtest) {
            let html = '<p>暂无回测数据</p>';
            if (backtest && backtest.performance_metrics) {
                const metrics = backtest.performance_metrics;
                html = `
                    <p><strong>总收益率：</strong>${(metrics.total_return * 100).toFixed(2)}%</p>
                    <p><strong>年化收益率：</strong>${(metrics.annualized_return * 100).toFixed(2)}%</p>
                    <p><strong>最大回撤：</strong>${(metrics.max_drawdown * 100).toFixed(2)}%</p>
                    <p><strong>夏普比率：</strong>${metrics.sharpe_ratio.toFixed(2)}</p>
                    <p><strong>胜率：</strong>${(metrics.win_rate * 100).toFixed(2)}%</p>
                    <p><strong>总交易次数：</strong>${metrics.total_trades}</p>
                    <p><strong>盈亏因子：</strong>${metrics.profit_factor.toFixed(2)}</p>
                `;
            }
            document.getElementById('backtestResults').innerHTML = html;
        }
        
        // 显示风险报告
        function displayRiskReport(riskReport) {
            let html = '';
            if (typeof riskReport === 'string') {
                html = `<p>${riskReport}</p>`;
            } else if (riskReport.risk_level) {
                html = `
                    <p><strong>风险等级：</strong><span class="font-bold ${getRiskColor(riskReport.risk_level)}">${riskReport.risk_level}</span></p>
                    <p><strong>风险评分：</strong>${riskReport.risk_score.toFixed(1)} / 10</p>
                    <p><strong>建议仓位：</strong>${(riskReport.position_size * 100).toFixed(1)}%</p>
                    <p><strong>止损位：</strong>${riskReport.stop_loss.toFixed(2)}</p>
                    <p><strong>止盈位：</strong>${riskReport.take_profit.toFixed(2)}</p>
                `;
            } else {
                html = '<p>暂无风险数据</p>';
            }
            document.getElementById('riskReport').innerHTML = html;
        }

        function getRiskColor(level) {
            switch(level) {
                case 'LOW': return 'text-green-600';
                case 'MEDIUM': return 'text-yellow-600';
                case 'HIGH': return 'text-orange-600';
                case 'VERY_HIGH': return 'text-red-600';
                default: return 'text-gray-600';
            }
        }

        // 初始化
        document.getElementById('stockInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                analyzeStock();
            }
        });

        // 页面加载时获取热门股票
        loadPopularStocks();

        // 新增：全局缓存与排序模式
        let picksCache = [];
        let sortMode = 'expected_return_desc';
        async function loadStockPicks() {
            try {
                console.log('开始加载智能选股榜单...');
                document.getElementById('stockPicksLoading').classList.remove('hidden');
                const resp = await fetch('/api/stock-picks');
                console.log('API响应状态:', resp.status);
                const data = await resp.json();
                console.log('API响应数据:', data);
                const picks = (data && data.data && data.data.picks) ? data.data.picks : [];
                const msg = (data && data.data && data.data.message) ? data.data.message : '';
                console.log('解析的picks数量:', picks.length);
                // 缓存数据
                picksCache = picks;
                renderStockPicks(picksCache, msg);
            } catch (e) {
                console.error('加载选股榜单失败:', e);
                renderStockPicks([], '获取选股榜单失败');
            } finally {
                document.getElementById('stockPicksLoading').classList.add('hidden');
            }
        }

        // 新增：排序模式变更
        function onSortModeChange() {
            const sel = document.getElementById('sortMode');
            sortMode = sel ? sel.value : 'expected_return_desc';
            renderStockPicks(picksCache);
        }

        // 新增：排序逻辑
        function applySort(arr) {
            const list = Array.isArray(arr) ? [...arr] : [];
            if (sortMode === 'expected_return_desc') {
                return list.sort((a, b) => {
                    const av = (a && a.expected_return_30d != null) ? a.expected_return_30d : -Infinity;
                    const bv = (b && b.expected_return_30d != null) ? b.expected_return_30d : -Infinity;
                    return bv - av;
                });
            } else if (sortMode === 'prob_up_desc') {
                return list.sort((a, b) => {
                    const ap = (a && (a.prob_up_30d != null ? a.prob_up_30d : a.probability != null ? a.probability : 0));
                    const bp = (b && (b.prob_up_30d != null ? b.prob_up_30d : b.probability != null ? b.probability : 0));
                    return bp - ap;
                });
            }
            return list;
        }

        function renderStockPicks(picks, message) {
            const container = document.getElementById('stockPicks');
            if (!Array.isArray(picks) || picks.length === 0) {
                container.innerHTML = `<p class="text-gray-500">${message || '暂无数据，请尝试点击"增量刷新数据"'}</p>`;
                return;
            }
            const sorted = applySort(picks);
            container.innerHTML = sorted.map(p => {
                const probVal = (p && (p.prob_up_30d != null ? p.prob_up_30d : p.probability != null ? p.probability : null));
                const probPct = probVal != null ? (probVal * 100).toFixed(1) + '%' : '-';
                const expectedRet = (p && p.expected_return_30d != null) ? (p.expected_return_30d * 100).toFixed(1) + '%' : '-';
                const probColor = (probVal != null && probVal > 0.5) ? 'text-green-600' : 'text-gray-600';
                return `
                <div class="border border-gray-200 rounded p-3 hover:shadow cursor-pointer" onclick="document.getElementById('stockInput').value='${p.symbol}'; analyzeStock();">
                    <div class="flex justify-between">
                        <div>
                            <div class="font-semibold text-gray-800">${p.name || p.symbol}</div>
                            <div class="text-xs text-gray-500">${p.symbol}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold ${probColor}">${probPct}</div>
                            <div class="text-xs text-gray-500">30天上涨概率</div>
                        </div>
                    </div>
                    <div class="mt-2 text-sm text-gray-700">
                        <span>收盘: ${p.last_close!=null? Number(p.last_close).toFixed(2) : '-'}</span>
                        <span class="ml-3">看多: ${p.sentiment || '-'}</span>
                        <span class="ml-3">信心: ${p.confidence!=null? p.confidence.toFixed(1)+'%' : '-'}</span>
                        <span class="ml-3 text-green-700">看多: ${p.long_signals ?? '-'}</span>
                        <span class="ml-3 text-red-700">看空: ${p.short_signals ?? '-'}</span>
                        <span class="ml-3 font-medium">30天预期收益: <span class="${(p.expected_return_30d!=null && p.expected_return_30d>=0)?'text-green-700':'text-red-700'}">${expectedRet}</span></span>
                    </div>
                </div>`;
            }).join('');
        }

        async function refreshDataAndReloadPicks() {
            try {
                document.getElementById('stockPicksLoading').classList.remove('hidden');
                await fetch('/api/refresh-data?max_symbols=50', { method: 'POST' });
            } catch (e) {
                // ignore
            } finally {
                document.getElementById('stockPicksLoading').classList.add('hidden');
            }
            loadStockPicks();
        }

        // 页面加载时获取智能选股榜单
        loadStockPicks();
    </script>
</body>
</html>