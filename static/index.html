<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股票分析系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com/?plugins=typography"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    <script>
        // 统一 API 基础地址：如需跨域部署可提前在页面注入 window.API_BASE
        const API_BASE = window.API_BASE || window.location.origin;
        function api(path) {
            // 确保 path 以 / 开头
            return `${API_BASE}${path.startsWith('/') ? path : '/' + path}`;
        }
    </script>
    <script>
        // 覆盖全局 fetch，将硬编码 localhost:8003 自动替换为 API_BASE
        (function() {
            const ORIGINAL_FETCH = window.fetch.bind(window);
            window.fetch = function(input, init) {
                if (typeof input === 'string' && input.startsWith('http://localhost:8003')) {
                    input = api(input.substring('http://localhost:8003'.length));
                }
                return ORIGINAL_FETCH(input, init);
            };
        })();
    </script>
    <style>
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 标签页样式优化 */
        .tab-active {
            color: #2563eb !important;
            border-bottom-color: #2563eb !important;
            background-color: #f8fafc;
        }
        
        .tab-inactive {
            color: #6b7280;
            border-bottom: 2px solid transparent;
        }
        
        .tab-inactive:hover {
            color: #2563eb;
            background-color: #f1f5f9;
        }
        
        /* 内容区域过渡动画 */
        .content-section {
            transition: opacity 0.3s ease-in-out;
        }
        
        .content-section.hidden {
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- 头部 -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-4">智能股票分析系统</h1>
            <p class="text-gray-600">基于大模型的股票技术分析与投资建议</p>
        </div>

        <!-- 导航菜单 -->
        <div class="bg-white rounded-lg shadow-md mb-8">
            <nav class="flex border-b">
                <button id="tab-stock-picks" class="px-6 py-4 tab-active font-medium transition-all duration-200" onclick="switchTab('stock-picks')">
                    智能选股
                </button>
                <button id="tab-stock-analysis" class="px-6 py-4 tab-inactive font-medium transition-all duration-200" onclick="switchTab('stock-analysis')">
                    个股分析
                </button>
                <button id="tab-system-status" class="px-6 py-4 tab-inactive font-medium transition-all duration-200" onclick="switchTab('system-status')">
                    系统状态
                </button>
                <a href="./portfolios.html" class="px-6 py-4 tab-inactive font-medium transition-all duration-200" target="_self">
                    持仓组合
                </a>
            </nav>
        </div>

        <!-- 个股分析模块 -->
        <div id="content-stock-analysis" class="content-section hidden">
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">个股分析</h2>
                <div class="flex flex-col md:flex-row gap-4 items-center">
                    <input 
                        type="text" 
                        id="stockInput" 
                        placeholder="输入股票代码（如：600036.SH）" 
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                    <button 
                        onclick="analyzeStockInNewTab()" 
                        class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200"
                    >
                        分析股票
                    </button>
                    <div id="loading" class="hidden">
                        <div class="loading"></div>
                    </div>
                </div>
                
                <!-- 热门股票 -->
                <div class="mt-4">
                    <p class="text-sm text-gray-600 mb-2">热门股票：</p>
                    <div id="popularStocks" class="flex flex-wrap gap-2">
                        <!-- 动态加载 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 智能选股模块 -->
        <div id="content-stock-picks" class="content-section block">
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-xl font-semibold text-gray-800">智能选股榜单</h2>
                    <div class="flex items-center gap-2">
                        <label for="sortMode" class="text-sm text-gray-600">排序</label>
                        <select id="sortMode" class="px-2 py-1 border border-gray-300 rounded text-sm" onchange="onSortModeChange()">
                            <option value="expected_return_desc">按预期收益</option>
                            <option value="prob_up_desc">按30天上涨概率</option>
                            <option value="default">默认</option>
                        </select>
                        <button onclick="loadStockPicks()" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm transition-colors duration-200">刷新榜单</button>
                        <!-- 新增：同步类型选择 -->
                        <label for="syncType" class="text-sm text-gray-600">同步类型</label>
                        <select id="syncType" class="px-2 py-1 border border-gray-300 rounded text-sm">
                            <option value="incremental" selected>增量</option>
                            <option value="full">全量</option>
                        </select>
                        <!-- 新增：数据源选择（多选） -->
                        <div class="flex items-center gap-2 text-sm">
                            <span class="text-sm text-gray-600">数据源</span>
                            <label class="inline-flex items-center gap-1"><input type="checkbox" name="source" value="eastmoney" class="rounded" checked>东财</label>
                            <label class="inline-flex items-center gap-1"><input type="checkbox" name="source" value="sina" class="rounded" checked>新浪</label>
                            <label class="inline-flex items-center gap-1"><input type="checkbox" name="source" value="tencent" class="rounded" checked>腾讯</label>
                            <label class="inline-flex items-center gap-1"><input type="checkbox" name="source" value="xueqiu" class="rounded" checked>雪球</label>
                            <label class="inline-flex items-center gap-1"><input type="checkbox" name="source" value="akshare" class="rounded" checked>Akshare</label>
                        </div>
                        <button id="refresh-button" onclick="refreshDataAndReloadPicks()" class="px-3 py-1 bg-gray-700 text-white rounded hover:bg-gray-800 text-sm transition-colors duration-200">同步数据</button>
                        <button id="optimized-refresh-button" onclick="refreshDataOptimizedAndReloadPicks()" class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm transition-colors duration-200">优化同步</button>
                    </div>
                </div>
                <div id="stockPicksLoading" class="hidden mb-3"><div class="loading"></div></div>
                <div id="stockPicks" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
            </div>
        </div>

        <!-- 系统状态模块 -->
        <div id="content-system-status" class="content-section hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- 同步状态卡片 -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-lg font-semibold text-gray-800">同步状态</h2>
                        <button onclick="loadSyncStatus()" class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-sm transition-colors duration-200">刷新</button>
                    </div>
                    <div id="syncStatusContainer" class="text-sm text-gray-700">
                        <p class="text-gray-500">加载中...</p>
                    </div>
                </div>

                <!-- 数据新鲜度卡片 -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-lg font-semibold text-gray-800">数据新鲜度</h2>
                        <button onclick="loadDataFreshness()" class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-sm transition-colors duration-200">刷新</button>
                    </div>
                    <div id="dataFreshnessContainer" class="text-sm text-gray-700">
                        <p class="text-gray-500">加载中...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 结果显示区域 -->
        <div id="loading" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
            <div class="flex items-center gap-2">
                <div class="loading"></div>
                <span class="text-blue-800">正在分析股票...</span>
            </div>
        </div>

        <div id="error" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
            <div class="text-red-800" id="errorMessage"></div>
        </div>

        <div id="result" class="hidden bg-white rounded-lg shadow-md p-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- 基本信息 -->
                <div class="bg-blue-50 rounded-lg p-4">
                    <h3 class="text-lg font-semibold mb-3 text-blue-800">股票基本信息</h3>
                    <div id="basicInfo"></div>
                </div>

                <!-- 技术指标 -->
                <div class="bg-green-50 rounded-lg p-4">
                    <h3 class="text-lg font-semibold mb-3 text-green-800">技术指标</h3>
                    <div id="technicalInfo"></div>
                </div>

                <!-- AI分析 -->
                <div class="lg:col-span-2 bg-purple-50 rounded-lg p-4">
                    <h3 class="text-lg font-semibold mb-3 text-purple-800">AI投资建议</h3>
                    <div id="aiAnalysis" class="prose max-w-none"></div>
                </div>

                <!-- 交易信号 -->
                <div class="lg:col-span-2 bg-yellow-50 rounded-lg p-4">
                    <h3 class="text-lg font-semibold mb-3 text-yellow-800">近期交易信号</h3>
                    <div id="signals"></div>
                </div>

                <!-- K线图 -->
                <div class="lg:col-span-2 bg-white rounded-lg p-4 border border-gray-200">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800">K线图与技术分析</h3>
                    <div id="chartContainer" style="height: 400px;">
                        <div id="stockChart" style="width:100%;height:100%;"></div>
                    </div>
                </div>

                <!-- 回测结果 -->
                <div class="lg:col-span-1 bg-blue-50 rounded-lg p-4">
                    <h3 class="text-lg font-semibold mb-3 text-blue-800">回测结果</h3>
                    <div id="backtestResults"></div>
                </div>

                <!-- 风险报告 -->
                <div class="lg:col-span-1 bg-red-50 rounded-lg p-4">
                    <h3 class="text-lg font-semibold mb-3 text-red-800">风险分析</h3>
                    <div id="riskReport"></div>
                </div>
            </div>
        </div>


    </div>

    <script>
        // 加载热门股票
        async function loadPopularStocks() {
            try {
                const response = await fetch('http://localhost:8003/api/popular-stocks');
                const data = await response.json();
                const container = document.getElementById('popularStocks');
                container.innerHTML = '';
                
                data.stocks.forEach(stock => {
                    const button = document.createElement('button');
                    button.className = 'px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300';
                    button.textContent = `${stock.name} (${stock.symbol})`;
                    button.onclick = () => {
                        document.getElementById('stockInput').value = stock.symbol;
                        analyzeStock();
                    };
                    container.appendChild(button);
                });
            } catch (error) {
                console.error('加载热门股票失败:', error);
            }
        }

        // 渲染K线图
        // ECharts 实例
        let echartsInstance = null;

        function renderStockChart(chartData) {
            const container = document.getElementById('stockChart');

            // 销毁旧实例
            if (echartsInstance) {
                try { echartsInstance.dispose(); } catch (e) { /* ignore */ }
                echartsInstance = null;
            }

            echartsInstance = echarts.init(container);

            // 准备 K 线数据：使用 category x 轴（显式的日期数组）和 values 数组
            const dates = (chartData.kline || []).map(item => item[0]);
            // ECharts K 线值顺序为 [open, close, low, high]
            const kValues = (chartData.kline || []).map(item => [item[1], item[2], item[3], item[4]]);

            // 收盘价线：使用与 dates 索引对齐的纯数值数组（便于 dataZoom 基于索引工作）
            const closeLineData = (chartData.kline || []).map(item => item[2]);

            // 组合净值：先构建日期->净值映射，再按 dates 顺序生成对齐数组（缺失用 null 填充）
            const portfolioMap = {};
            (chartData.portfolio || []).forEach(p => { if (p && p.date) portfolioMap[p.date] = p.value; });
            const portfolioData = dates.map(d => (portfolioMap[d] != null ? portfolioMap[d] : null));

            // 交易标记：使用 [index, price] 的格式，确保与类目轴索引对齐
            const buyData = [];
            const sellData = [];
            (chartData.trade_markers || []).forEach(t => {
                const idx = dates.indexOf(t.date);
                if (idx === -1) return; // skip markers outside the shown kline window
                const price = (t.price != null ? t.price : null);
                if (t.type && t.type.toUpperCase() === 'BUY') buyData.push([idx, price]);
                else if (t.type && t.type.toUpperCase() === 'SELL') sellData.push([idx, price]);
                else buyData.push([idx, price]);
            });

            const option = {
                backgroundColor: '#fff',
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' }
                },
                toolbox: {
                    feature: { saveAsImage: {} }
                },
                dataZoom: [
                    { type: 'inside', xAxisIndex: 0, throttle: 50 },
                    { type: 'slider', xAxisIndex: 0 }
                ],
                // 使用类目坐标轴并显式设置日期，使用索引对齐（boundaryGap=false 更适合时间序列）
                xAxis: { type: 'category', data: dates, boundaryGap: false },
                yAxis: [
                    { scale: true, name: '价格', position: 'left' },
                    { scale: true, name: '组合净值', position: 'right' }
                ],
                series: [
                    {
                        name: 'K线',
                        type: 'candlestick',
                        // 使用与 xAxis.data 对齐的值数组
                        data: kValues,
                        itemStyle: { color: '#ec0000', color0: '#00da3c', borderColor: '#8A0000', borderColor0: '#008F3D' }
                    },
                    {
                        name: '收盘价',
                        type: 'line',
                        // 与类目轴按索引对齐的纯数值数组
                        data: closeLineData,
                        smooth: true,
                        lineStyle: { color: '#4bc0c0' },
                        showSymbol: false,
                        yAxisIndex: 0
                    },
                    {
                        name: '组合净值',
                        type: 'line',
                        data: portfolioData,
                        smooth: true,
                        lineStyle: { color: '#ff9f40' },
                        showSymbol: false,
                        yAxisIndex: 1
                    },
                    {
                        name: '买入',
                        type: 'scatter',
                        // scatter 使用 [index, value]，索引对应 xAxis.data
                        data: buyData,
                        symbol: 'pin',
                        symbolSize: 20,
                        symbolOffset: [0, 15],
                        itemStyle: { color: '#00ff00' },
                        yAxisIndex: 0
                    },
                    {
                        name: '卖出',
                        type: 'scatter',
                        data: sellData,
                        symbol: 'pin',
                        symbolSize: 20,
                        symbolOffset: [0, -15],
                        itemStyle: { color: '#ff0000' },
                        yAxisIndex: 0
                    }
                ]
            };

            // 改进 tooltip：展示对应的日期（使用 dates 数组按 dataIndex 映射）
            option.tooltip.formatter = function (params) {
                if (!params || !params.length) return '';
                const idx = params[0].dataIndex;
                const date = dates[idx] || params[0].name || '';
                let txt = '<b>' + date + '</b><br/>';
                params.forEach(p => {
                    txt += p.seriesName + ': ' + (p.value != null ? (Array.isArray(p.value) ? p.value[1] : p.value) : '-') + '<br/>';
                });
                return txt;
            };

            echartsInstance.setOption(option);

            // 响应式
            window.addEventListener('resize', function() { try { echartsInstance.resize(); } catch (e) {} });
        }
        
        // 显示回测结果
        function displayBacktestResults(backtestData) {
            const backtestDiv = document.getElementById('backtestResults');
            
            if (!backtestDiv) {
                console.warn('回测结果容器未找到');
                return;
            }
            
            if (!backtestData) {
                backtestDiv.innerHTML = '<p class="text-gray-500">暂无回测数据</p>';
                return;
            }
            
            const totalReturn = backtestData.total_return ? (backtestData.total_return * 100).toFixed(2) : '0.00';
            const annualizedReturn = backtestData.annualized_return ? (backtestData.annualized_return * 100).toFixed(2) : '0.00';
            const maxDrawdown = backtestData.max_drawdown ? (backtestData.max_drawdown * 100).toFixed(2) : '0.00';
            const sharpeRatio = backtestData.sharpe_ratio ? backtestData.sharpe_ratio.toFixed(2) : '0.00';
            const winRate = backtestData.win_rate ? (backtestData.win_rate * 100).toFixed(2) : '0.00';
            
            const returnColor = totalReturn >= 0 ? 'text-red-500' : 'text-green-500';
            
            backtestDiv.innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-4">
                    <div class="bg-gray-50 p-3 rounded text-center">
                        <div class="text-sm text-gray-600">总收益率</div>
                        <div class="text-lg font-bold ${returnColor}">${totalReturn}%</div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded text-center">
                        <div class="text-sm text-gray-600">年化收益率</div>
                        <div class="text-lg font-bold">${annualizedReturn}%</div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded text-center">
                        <div class="text-sm text-gray-600">最大回撤</div>
                        <div class="text-lg font-bold text-orange-500">${maxDrawdown}%</div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded text-center">
                        <div class="text-sm text-gray-600">夏普比率</div>
                        <div class="text-lg font-bold">${sharpeRatio}</div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded text-center">
                        <div class="text-sm text-gray-600">胜率</div>
                        <div class="text-lg font-bold">${winRate}%</div>
                    </div>
                </div>
                
                ${backtestData.trades && backtestData.trades.length > 0 ? `
                    <div class="mt-4">
                        <h4 class="text-lg font-semibold mb-2">最近交易记录</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/5">日期</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/6">操作</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/6">价格</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/6">数量</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">收益</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${backtestData.trades.slice(-5).map(trade => {
                                        const profitColor = trade.profit >= 0 ? 'text-green-500' : 'text-red-500';
                                        return `
                                            <tr class="hover:bg-gray-50">
                                                <td class="px-4 py-3 text-sm text-gray-900">${trade.date || '-'}</td>
                                                <td class="px-4 py-3 text-sm">
                                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${trade.action === '买入' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                                        ${trade.action || '-'}
                                                    </span>
                                                </td>
                                                <td class="px-4 py-3 text-sm text-gray-900 font-medium">¥${trade.price ? trade.price.toFixed(2) : '-'}</td>
                                                <td class="px-4 py-3 text-sm text-gray-900">${trade.quantity || '-'}</td>
                                                <td class="px-4 py-3 text-sm font-semibold ${profitColor}">¥${trade.profit ? trade.profit.toFixed(2) : '-'}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                ` : ''}
            `;
        }
        
        // 显示风险报告
        function displayRiskReport(riskReport) {
            const riskDiv = document.getElementById('riskReport');
            
            if (!riskDiv) {
                console.warn('风险报告容器未找到');
                return;
            }
            
            if (!riskReport) {
                riskDiv.innerHTML = '<p class="text-gray-500">暂无风险报告</p>';
                return;
            }
            
            let html = '';
            if (typeof riskReport === 'string') {
                html = `<p>${riskReport}</p>`;
            } else if (riskReport.risk_level) {
                const volatility = riskReport.volatility ? (riskReport.volatility * 100).toFixed(2) : '0.00';
                const beta = riskReport.beta ? riskReport.beta.toFixed(2) : '0.00';
                const var95 = riskReport.var_95 ? (riskReport.var_95 * 100).toFixed(2) : '0.00';
                const maxLoss = riskReport.max_single_loss ? (riskReport.max_single_loss * 100).toFixed(2) : '0.00';
                
                html = `
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <div class="bg-gray-50 p-3 rounded text-center">
                            <div class="text-sm text-gray-600">波动率</div>
                            <div class="text-lg font-bold text-orange-500">${volatility}%</div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded text-center">
                            <div class="text-sm text-gray-600">Beta系数</div>
                            <div class="text-lg font-bold">${beta}</div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded text-center">
                            <div class="text-sm text-gray-600">VaR (95%)</div>
                            <div class="text-lg font-bold text-red-500">${var95}%</div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded text-center">
                            <div class="text-sm text-gray-600">最大单损</div>
                            <div class="text-lg font-bold text-red-600">${maxLoss}%</div>
                        </div>
                    </div>
                    
                    <div class="p-3 bg-blue-50 rounded mb-4">
                        <div class="flex items-center mb-2">
                            <span class="text-blue-700 font-semibold">风险等级：</span>
                            <span class="ml-2 px-2 py-1 rounded text-sm ${getRiskColor(riskReport.risk_level)}">${riskReport.risk_level}</span>
                        </div>
                        <p><strong>风险评分：</strong>${riskReport.risk_score.toFixed(1)} / 10</p>
                        <p><strong>建议仓位：</strong>${(riskReport.position_size * 100).toFixed(1)}%</p>
                        <p><strong>止损位：</strong>${riskReport.stop_loss.toFixed(2)}</p>
                        <p><strong>止盈位：</strong>${riskReport.take_profit.toFixed(2)}</p>
                        ${riskReport.risk_description ? `<p class="text-sm text-blue-600 mt-2">${riskReport.risk_description}</p>` : ''}
                    </div>
                    
                    ${riskReport.recommendations && riskReport.recommendations.length > 0 ? `
                        <div class="mt-4">
                            <h4 class="text-lg font-semibold mb-2">风险建议</h4>
                            <ul class="list-disc list-inside space-y-1">
                                ${riskReport.recommendations.map(rec => `
                                    <li class="text-sm text-gray-700">${rec}</li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}
                `;
            } else {
                html = '<p class="text-gray-500">暂无风险数据</p>';
            }
            riskDiv.innerHTML = html;
        }

        function getRiskColor(level) {
            switch(level) {
                case 'LOW': return 'text-green-600';
                case 'MEDIUM': return 'text-yellow-600';
                case 'HIGH': return 'text-orange-600';
                case 'VERY_HIGH': return 'text-red-600';
                default: return 'text-gray-600';
            }
        }

        // 初始化
        document.getElementById('stockInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                analyzeStock();
            }
        });

        // 页面加载时获取热门股票
        loadPopularStocks();

        // 新增：全局缓存与排序模式
        let picksCache = [];
        let sortMode = 'expected_return_desc';
        async function loadStockPicks() {
            try {
                console.log('开始加载智能选股榜单...');
                document.getElementById('stockPicksLoading').classList.remove('hidden');
                const response = await fetch('http://localhost:8003/api/stock-picks?top_n=60&limit_symbols=3000');
                console.log('API响应状态:', response.status);
                const data = await response.json();
                console.log('API响应数据:', data);
                const picks = (data && data.data && data.data.picks) ? data.data.picks : [];
                const msg = (data && data.data && data.data.message) ? data.data.message : '';
                console.log('解析的picks数量:', picks.length);
                // 缓存数据
                picksCache = picks;
                renderStockPicks(picksCache, msg);
            } catch (e) {
                console.error('加载选股榜单失败:', e);
                renderStockPicks([], '获取选股榜单失败');
            } finally {
                document.getElementById('stockPicksLoading').classList.add('hidden');
            }
        }

        // 新增：排序模式变更
        function onSortModeChange() {
            const sel = document.getElementById('sortMode');
            sortMode = sel ? sel.value : 'expected_return_desc';
            renderStockPicks(picksCache);
        }

        // 新增：排序逻辑
        function applySort(arr) {
            const list = Array.isArray(arr) ? [...arr] : [];
            if (sortMode === 'expected_return_desc') {
                return list.sort((a, b) => {
                    const av = (a && a.expected_return_30d != null) ? a.expected_return_30d : -Infinity;
                    const bv = (b && b.expected_return_30d != null) ? b.expected_return_30d : -Infinity;
                    return bv - av;
                });
            } else if (sortMode === 'prob_up_desc') {
                return list.sort((a, b) => {
                    const ap = (a && (a.prob_up_30d != null ? a.prob_up_30d : a.probability != null ? a.probability : 0));
                    const bp = (b && (b.prob_up_30d != null ? b.prob_up_30d : b.probability != null ? b.probability : 0));
                    return bp - ap;
                });
            }
            return list;
        }

        function renderStockPicks(picks, message) {
            const container = document.getElementById('stockPicks');
            if (!Array.isArray(picks) || picks.length === 0) {
                container.innerHTML = `<p class="text-gray-500">${message || '暂无数据，请尝试点击"增量刷新数据"'}</p>`;
                return;
            }
            const sorted = applySort(picks);
            container.innerHTML = sorted.map(p => {
                const probVal = (p && (p.prob_up_30d != null ? p.prob_up_30d : p.probability != null ? p.probability : null));
                const probPct = probVal != null ? (probVal * 100).toFixed(1) + '%' : '-';
                const expectedRet = (p && p.expected_return_30d != null) ? (p.expected_return_30d * 100).toFixed(1) + '%' : '-';
                const probColor = (probVal != null && probVal > 0.5) ? 'text-green-600' : 'text-gray-600';
                // 构建雪球链接 - 修复链接格式，去掉市场后缀
                let cleanSymbol = p.symbol;
                // 去掉.SH、.SZ等市场后缀
                if (cleanSymbol.includes('.')) {
                    cleanSymbol = cleanSymbol.split('.')[0];
                }
                // 确保有正确的市场前缀
                const symbol = cleanSymbol.startsWith('SH') || cleanSymbol.startsWith('SZ') ? cleanSymbol : 
                              (cleanSymbol.startsWith('0') || cleanSymbol.startsWith('3') ? 'SZ' + cleanSymbol : 'SH' + cleanSymbol);
                const xueqiuUrl = `https://xueqiu.com/S/${symbol}`;
                return `
                <div class="border border-gray-200 rounded p-3 hover:shadow cursor-pointer relative" onclick="window.open('${xueqiuUrl}', '_blank');">
                    <div class="flex justify-between">
                        <div class="flex items-center">
                            <div>
                                <div class="font-semibold text-gray-800">${p.name || p.symbol}</div>
                                <div class="text-xs text-gray-500">${p.symbol}</div>
                            </div>
                            <!-- 分析按钮移到股票名字旁边 -->
                            <button class="ml-3 w-7 h-7 bg-blue-500 hover:bg-blue-600 text-white rounded-full flex items-center justify-center text-sm transition-colors" 
                                    onclick="event.stopPropagation(); analyzeStockFromCard('${p.symbol}');" 
                                    title="分析股票">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold ${probColor}">${probPct}</div>
                            <div class="text-xs text-gray-500">30天上涨概率</div>
                        </div>
                    </div>
                    <div class="mt-2 text-sm text-gray-700">
                        <span>收盘: ${p.last_close!=null? Number(p.last_close).toFixed(2) : '-'}</span>
                        <span class="ml-3">看多: ${p.sentiment || '-'}</span>
                        <span class="ml-3">信心: ${p.confidence!=null? p.confidence.toFixed(1)+'%' : '-'}</span>
                        <span class="ml-3 text-green-700">看多: ${p.long_signals ?? '-'}</span>
                        <span class="ml-3 text-red-700">看空: ${p.short_signals ?? '-'}</span>
                        <span class="ml-3 font-medium">30天预期收益: <span class="${(p.expected_return_30d!=null && p.expected_return_30d>=0)?'text-green-700':'text-red-700'}">${expectedRet}</span></span>
                    </div>
                </div>`;
            }).join('');
        }

        async function refreshDataOptimizedAndReloadPicks(maxSymbols = 50) {
            const refreshButton = document.getElementById('optimized-refresh-button');
            
            // Disable button and show loading state
            if (refreshButton) {
                refreshButton.disabled = true;
                refreshButton.textContent = '优化同步中...';
            }
            
            // 读取同步类型与数据源选择
            const syncTypeEl = document.getElementById('syncType');
            const syncType = syncTypeEl ? syncTypeEl.value : 'incremental';
            const selectedSources = Array.from(document.querySelectorAll('input[name="source"]:checked')).map(el => el.value);
            
            const requestBody = {
                sync_type: syncType,
                markets: ['A股主板', '创业板', '科创板'],
                batch_size: 50,
                delay_seconds: 0.2
            };
            
            // Make API call to refresh data using optimized endpoint
            fetch('http://localhost:8003/api/sync_data_optimized', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            })
            .then(async response => {
                let data;
                try {
                    data = await response.json();
                } catch (e) {
                    const text = await response.text();
                    data = { success: 0, error: text || `HTTP ${response.status}` };
                }
                return data;
            })
            .then(data => {
                console.log('优化版数据刷新结果:', data);
                
                if (data.success) {
                    console.log('优化版数据刷新成功，重新加载股票推荐...');
                    
                    // 显示优化统计信息
                    if (data.statistics && data.source_statistics) {
                        const stats = data.statistics;
                        const sourceStats = data.source_statistics;
                        alert(`优化同步完成！\n` +
                              `成功率: ${stats.success_rate}\n` +
                              `耗时: ${stats.elapsed_time}\n` +
                              `平均每股: ${stats.avg_time_per_stock}\n` +
                              `重试次数: ${sourceStats.total_retries || 0}\n` +
                              `熔断触发: ${sourceStats.circuit_breaker_triggers || 0}次`);
                    }
                    
                    loadStockPicks(); // 重新加载股票推荐
                    loadSyncStatus(); // 刷新同步状态
                    loadDataFreshness(); // 刷新数据新鲜度
                } else {
                    console.error('优化版数据刷新失败:', data.message);
                    alert('优化版数据刷新失败: ' + (data.message || '未知错误'));
                }
            })
            .catch(error => {
                console.error('优化版请求失败:', error);
                alert('优化版请求失败: ' + error.message);
            })
            .finally(() => {
                // Re-enable button
                if (refreshButton) {
                    refreshButton.disabled = false;
                    refreshButton.textContent = '优化同步';
                }
            });
        }

        async function refreshDataAndReloadPicks(maxSymbols = 50) {
            const refreshButton = document.getElementById('refresh-button');
            
            // Disable button and show loading state
            if (refreshButton) {
                refreshButton.disabled = true;
                refreshButton.textContent = '更新中...';
            }
            
            // 读取同步类型与数据源选择
            const syncTypeEl = document.getElementById('syncType');
            const syncType = syncTypeEl ? syncTypeEl.value : 'incremental';
            const selectedSources = Array.from(document.querySelectorAll('input[name="source"]:checked')).map(el => el.value);
            
            const requestBody = {
                sync_type: syncType,
                markets: ['SH', 'SZ'],
                force_full: syncType === 'full',
                preferred_sources: selectedSources.length ? selectedSources : undefined
            };
            
            // Make API call to refresh data
            fetch('http://localhost:8003/api/sync_data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            })
            .then(response => response.json())
            .then(data => {
                console.log('数据刷新结果:', data);
                
                if (data.success) {
                    console.log('数据刷新成功，重新加载股票推荐...');
                    loadStockPicks(); // 重新加载股票推荐
                    loadSyncStatus(); // 刷新同步状态
                    loadDataFreshness(); // 刷新数据新鲜度
                } else {
                    console.error('数据刷新失败:', data.error);
                    alert('数据刷新失败: ' + (data.error || '未知错误'));
                }
            })
            .catch(error => {
                console.error('请求失败:', error);
                alert('请求失败: ' + error.message);
            })
            .finally(() => {
                // Re-enable button
                if (refreshButton) {
                    refreshButton.disabled = false;
                    refreshButton.textContent = '同步数据';
                }
            });
        }

        // 加载同步状态
        async function loadSyncStatus() {
            const container = document.getElementById('syncStatusContainer');
            if (!container) return;
            container.innerHTML = '<div class="flex items-center gap-2 text-gray-500"><div class="loading"></div><span>加载中...</span></div>';
            try {
                const response = await fetch('http://localhost:8003/api/sync_status');
                const data = await response.json();
                if (!data.success) {
                    container.innerHTML = `<p class="text-red-600">获取失败: ${data.error || '未知错误'}</p>`;
                    return;
                }
                const info = data.data;
                if (!info || info.message) {
                    container.innerHTML = `<p class="text-gray-500">${info && info.message ? info.message : '暂无同步记录'}</p>`;
                    return;
                }
                const rows = Object.keys(info).map(k => {
                    const v = info[k];
                    return `<div class=\"flex justify-between border-b border-gray-100 py-1\"><span class=\"text-gray-500\">${k}</span><span class=\"font-medium\">${v == null ? '-' : v}</span></div>`;
                }).join('');
                container.innerHTML = rows || '<p class="text-gray-500">暂无同步记录</p>';
            } catch (e) {
                container.innerHTML = `<p class="text-red-600">请求失败: ${e.message}</p>`;
            }
        }

        // 加载数据新鲜度
        async function loadDataFreshness(markets = null) {
            const container = document.getElementById('dataFreshnessContainer');
            if (!container) return;
            container.innerHTML = '<div class="flex items-center gap-2 text-gray-500"><div class="loading"></div><span>加载中...</span></div>';
            try {
                const url = markets ? api(`/api/data_freshness?markets=${encodeURIComponent(markets.join(','))}`) : api('/api/data_freshness');
                const response = await fetch(url);
                const data = await response.json();
                if (!data.success) {
                    container.innerHTML = `<p class="text-red-600">获取失败: ${data.error || '未知错误'}</p>`;
                    return;
                }
                const list = data.markets || [];
                if (!list.length) {
                    container.innerHTML = '<p class="text-gray-500">暂无数据</p>';
                    return;
                }
                const html = list.map(m => {
                    const badge = m.is_fresh ? '<span class="ml-2 px-2 py-0.5 text-xs rounded bg-green-100 text-green-700">新鲜</span>' : '<span class="ml-2 px-2 py-0.5 text-xs rounded bg-yellow-100 text-yellow-700">滞后</span>';
                    const days = m.days_behind == null ? '-' : `${m.days_behind}天`;
                    return `
                        <div class=\"border border-gray-200 rounded p-3 mb-2\">
                            <div class=\"flex justify-between items-center\">
                                <div class=\"font-semibold text-gray-800\">${m.market || '-'}</div>
                                <div class=\"text-sm text-gray-600\">最新日期: <span class=\"font-medium\">${m.latest_date || '-'}</span>${badge}</div>
                            </div>
                            <div class=\"mt-2 text-sm text-gray-700\">
                                <span>股票数: <span class=\"font-medium\">${m.stock_count ?? '-'}</span></span>
                                <span class=\"ml-4\">滞后: <span class=\"font-medium ${m.is_fresh ? 'text-green-700' : 'text-yellow-700'}\">${days}</span></span>
                            </div>
                        </div>`;
                }).join('');
                container.innerHTML = html;
            } catch (e) {
                container.innerHTML = `<p class="text-red-600">请求失败: ${e.message}</p>`;
            }
        }

        // 标签页切换功能
        function switchTab(tabName) {
            // 隐藏所有内容区域
            document.getElementById('content-stock-picks').classList.add('hidden');
            document.getElementById('content-stock-analysis').classList.add('hidden');
            document.getElementById('content-system-status').classList.add('hidden');
            
            // 重置所有标签按钮样式
            document.getElementById('tab-stock-picks').className = 'px-6 py-4 text-gray-600 hover:text-blue-600 font-medium';
            document.getElementById('tab-stock-analysis').className = 'px-6 py-4 text-gray-600 hover:text-blue-600 font-medium';
            document.getElementById('tab-system-status').className = 'px-6 py-4 text-gray-600 hover:text-blue-600 font-medium';
            
            // 显示对应内容区域并激活标签
            if (tabName === 'stock-picks') {
                document.getElementById('content-stock-picks').classList.remove('hidden');
                document.getElementById('tab-stock-picks').className = 'px-6 py-4 text-blue-600 border-b-2 border-blue-600 font-medium';
            } else if (tabName === 'stock-analysis') {
                document.getElementById('content-stock-analysis').classList.remove('hidden');
                document.getElementById('tab-stock-analysis').className = 'px-6 py-4 text-blue-600 border-b-2 border-blue-600 font-medium';
                loadPopularStocks(); // 加载热门股票
            } else if (tabName === 'system-status') {
                document.getElementById('content-system-status').classList.remove('hidden');
                document.getElementById('tab-system-status').className = 'px-6 py-4 text-blue-600 border-b-2 border-blue-600 font-medium';
                loadSyncStatus(); // 刷新同步状态
                loadDataFreshness(); // 刷新数据新鲜度
            }
        }

        // 在新标签页中分析股票
        function analyzeStockInNewTab() {
            const stockInput = document.getElementById('stockInput');
            const symbol = stockInput.value.trim();
            
            if (!symbol) {
                alert('请输入股票代码');
                return;
            }
            
            // 构建分析页面URL
            const analysisUrl = `/analysis?symbol=${encodeURIComponent(symbol)}`;
            
            // 在新标签页中打开
            window.open(analysisUrl, '_blank');
        }

        // 智能选股卡片分析按钮在新标签页打开
        function analyzeStockCardInNewTab(symbol) {
            const analysisUrl = `/analysis?symbol=${encodeURIComponent(symbol)}`;
            window.open(analysisUrl, '_blank');
        }

        // 从股票卡片分析股票（在新标签页打开分析结果）
        function analyzeStockFromCard(symbol) {
            window.open(`/static/analysis.html?symbol=${encodeURIComponent(symbol)}`, '_blank');
        }

        // 分析股票（在当前页面显示结果）
        async function analyzeStock() {
            const stockInput = document.getElementById('stockInput');
            let symbol = stockInput.value.trim();
            
            if (!symbol) {
                alert('请输入股票代码');
                return;
            }
            
            // 自动添加股票代码后缀
            if (/^\d{6}$/.test(symbol)) {
                // 6位数字：6 开头默认为上交所，其余默认为深交所
                symbol = symbol.startsWith('6') ? symbol + '.SH' : symbol + '.SZ';
            }
            
            // 显示加载状态
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('error').classList.add('hidden');
            document.getElementById('result').classList.add('hidden');
            
            try {
                const response = await fetch('http://localhost:8003/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ symbol: symbol })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || '分析失败');
                }

                if (!data.data.success) {
                    throw new Error(data.data.error);
                }

                displayResults(data.data);
                
            } catch (error) {
                showError(error.message);
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        // 显示分析结果
        function displayResults(data) {
            // 先显示结果容器，再渲染图表，避免在隐藏容器中初始化 ECharts 导致尺寸为 0
            document.getElementById('result').classList.remove('hidden');
            
            // 基本信息
            document.getElementById('basicInfo').innerHTML = `
                <p><strong>股票名称：</strong>${data.stock_info.longName || data.stock_info.symbol}</p>
                <p><strong>当前价格：</strong>${data.latest_price.toFixed(2)}</p>
                <p><strong>行业：</strong>${data.stock_info.industry || 'N/A'}</p>
                <p><strong>市值：</strong>${data.stock_info.marketCap ? (data.stock_info.marketCap / 1e8).toFixed(2) + '亿元' : 'N/A'}</p>
            `;

            // 技术指标
            const techData = data.technical_data;
            document.getElementById('technicalInfo').innerHTML = `
                <p><strong>5日均线：</strong>${techData.MA5[Object.keys(techData.MA5)[0]].toFixed(2)}</p>
                <p><strong>20日均线：</strong>${techData.MA20[Object.keys(techData.MA20)[0]].toFixed(2)}</p>
                <p><strong>RSI：</strong>${techData.RSI[Object.keys(techData.RSI)[0]].toFixed(2)}</p>
                <p><strong>MACD：</strong>${techData.MACD[Object.keys(techData.MACD)[0]].toFixed(4)}</p>
            `;

            // AI分析 - 使用marked.js解析markdown格式
            const aiAnalysisElement = document.getElementById('aiAnalysis');
            // 使用marked解析markdown为HTML
            try {
                // 确保marked已正确加载
                if (typeof marked === 'function') {
                    aiAnalysisElement.innerHTML = marked(data.ai_analysis);
                } else if (marked && typeof marked.parse === 'function') {
                    aiAnalysisElement.innerHTML = marked.parse(data.ai_analysis);
                } else {
                    // 如果marked不可用，回退到简单的换行处理
                    aiAnalysisElement.innerHTML = data.ai_analysis.replace(/\n/g, '<br>');
                }
            } catch (error) {
                console.error('Markdown解析错误:', error);
                // 出错时回退到简单的换行处理
                aiAnalysisElement.innerHTML = data.ai_analysis.replace(/\n/g, '<br>');
            }
            // 移除之前的CSS类，使用Tailwind Typography插件的prose类，并添加markdown-body-ai样式
            aiAnalysisElement.classList.remove('whitespace-pre-line', 'leading-relaxed');
            aiAnalysisElement.classList.add('markdown-body-ai');

            // 交易信号
            const signalsHtml = data.signals.length > 0 ? 
                data.signals.map(signal => `
                    <div class="p-2 mb-2 rounded ${signal.type === 'BUY' ? 'bg-red-100' : (signal.type === 'SELL' ? 'bg-green-100' : 'bg-yellow-100')}">
                        <strong>${signal.date}</strong> - 
                        <span class="${signal.type === 'BUY' ? 'text-red-800' : (signal.type === 'SELL' ? 'text-green-800' : 'text-yellow-800')}">
                            ${signal.type} @ ${signal.price.toFixed(2)}
                        </span>
                        <br><small>${signal.reason}</small>
                    </div>
                `).join('') :
                '<p>近期无交易信号</p>';
            
            document.getElementById('signals').innerHTML = signalsHtml;

            // 显示K线图（在容器可见后渲染）
            if (data.chart_data && data.chart_data.kline) {
                renderStockChart(data.chart_data);
            }

            // 显示回测结果
            if (data.backtest) {
                displayBacktestResults(data.backtest);
            }

            // 显示风险报告
            if (data.risk_report) {
                displayRiskReport(data.risk_report);
            }
        }

        // 加载热门股票
        async function loadPopularStocks() {
            const container = document.getElementById('popularStocks');
            if (!container) return;
            
            try {
                const response = await fetch('http://localhost:8003/api/popular-stocks');
                const data = await response.json();
                
                if (data.success && data.stocks) {
                    const stockButtons = data.stocks.map(stock => 
                        `<button onclick="document.getElementById('stockInput').value='${stock}'; analyzeStockInNewTab();" 
                                class="px-3 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 text-sm">
                            ${stock}
                        </button>`
                    ).join('');
                    container.innerHTML = stockButtons;
                } else {
                    // 如果API不存在，显示默认热门股票
                    const defaultStocks = ['000001.SZ', '000002.SZ', '600036.SH', '600519.SH', '000858.SZ'];
                    const stockButtons = defaultStocks.map(stock => 
                        `<button onclick="document.getElementById('stockInput').value='${stock}'; analyzeStockInNewTab();" 
                                class="px-3 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 text-sm">
                            ${stock}
                        </button>`
                    ).join('');
                    container.innerHTML = stockButtons;
                }
            } catch (error) {
                console.error('加载热门股票失败:', error);
                // 显示默认热门股票
                const defaultStocks = ['000001.SZ', '000002.SZ', '600036.SH', '600519.SH', '000858.SZ'];
                const stockButtons = defaultStocks.map(stock => 
                    `<button onclick="document.getElementById('stockInput').value='${stock}'; analyzeStockInNewTab();" 
                                class="px-3 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 text-sm">
                            ${stock}
                        </button>`
                ).join('');
                container.innerHTML = stockButtons;
            }
        }

        // 页面加载时初始化
        loadSyncStatus();
        loadDataFreshness();

        // 监听Enter键触发分析
        document.getElementById('stockInput').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                analyzeStockInNewTab();
            }
        });
    </script>
</body>
</html>